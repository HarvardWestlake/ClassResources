<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>File Permissions â€” Terminal Tutor</title>
    <style>
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: #0c0c0c; /* Windows Terminal dark */
        color: #cccccc;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        overflow: hidden; /* hide page scrollbar; use terminal's internal scroll */
      }
      /* Keyword highlighting */
      .kw-file {
        color: #ffd54a; /* yellow */
      }
      .kw-directory {
        color: #4da3ff; /* blue */
      }
      .kw-cd {
        color: #ff5bd6; /* pink */
      }
      .kw-ls {
        color: #4dff7a; /* green */
      }
      .kw-ch {
        color: #ff9a3c; /* orange (chmod/chgrp/chown) */
      }
      .kw-sudo {
        color: #ff4d4d; /* red */
      }
      .kw-owner-group {
        color: #b36bff; /* purple */
      }
      .term {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #0c0c0c; /* terminal background */
        border: 1px solid #2a2a2a;
        border-radius: 10px;
        overflow: hidden;
      }
      .term-header {
        display: flex;
        align-items: stretch;
        gap: 8px;
        height: auto; /* allow wrapping on small screens */
        min-height: 36px;
        background: #1a1a1a;
        border-bottom: 1px solid #2a2a2a;
        padding: 0 8px;
      }
      .term-tabs {
        display: flex;
        align-items: stretch;
        gap: 6px;
        flex: 1;
        min-width: 0;
        flex-wrap: wrap; /* keep tabs visible at any window size */
      }
      .term-tab {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        font-size: 12px;
        color: #cccccc;
        background: #2a2a2a;
        border: 1px solid #3a3a3a;
        border-bottom: none;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        /* Don't cap tabs to a tiny %; allow them to size naturally and wrap */
        max-width: min(320px, 80vw);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        align-self: stretch;
        /* Ensure the tab touches header borders without gaps */
        margin-bottom: 0;
        margin-top: 0;
      }
      /* Push the Filesystem tab to the far right of the header */
      .term-tab.fs-tab {
        margin-left: auto;
      }
      .term-tab.active {
        background: #0c0c0c;
        color: #ffffff;
        border-color: #4a4a4a;
      }
      /* Body can be a split-pane when the Filesystem tab is active */
      .term-body {
        display: flex;
        flex: 1;
        min-height: 0; /* allow child overflow scroll areas to work */
        min-width: 0;
      }
      .term-screen {
        padding: 12px 14px;
        overflow-y: auto;
        white-space: pre-wrap;
        flex: 1;
        min-width: 0;
        min-height: 0;
        background: #0c0c0c;
      }
      .fs-pane {
        display: none;
        padding: 12px 14px;
        overflow-y: auto;
        white-space: normal;
        flex: 1;
        min-width: 0;
        min-height: 0;
        background: #0c0c0c;
        border-left: 1px solid #2a2a2a;
      }
      /* Fullscreen filesystem mode (terminal hidden) */
      .term-body.fs-fullscreen .fs-pane {
        border-left: none;
      }
      .fs-breadcrumbs {
        color: #ddd;
        font-size: 12px;
        margin: 4px 0 8px;
      }
      .fs-breadcrumbs .crumb {
        cursor: pointer;
        color: #8ab4f8;
      }
      .fs-breadcrumbs .sep {
        color: #777;
        margin: 0 4px;
      }
      /* Campus map */
      .fs-map {
        display: block;
        width: 100%;
        height: 520px;
        border: 1px solid #2a2a2a;
        background: #0c0c0c;
      }
      .fs-building {
        fill: #6e1b1b; /* deep red */
        stroke: #a33a3a;
        stroke-width: 1;
      }
      .fs-roof {
        fill: #892424; /* darker red roof */
        stroke: #a33a3a;
        stroke-width: 1;
      }
      .fs-file {
        fill: #2a2a2a;
        stroke: #555;
        stroke-width: 1;
      }
      .fs-file-fold {
        fill: #3a3a3a;
        stroke: #666;
        stroke-width: 1;
      }
      .fs-building.current {
        stroke: #fce94f;
        stroke-width: 2;
      }
      .fs-building text {
        fill: #e0e6f1;
        font-size: 11px;
        pointer-events: none;
      }
      .fs-perm-on {
        fill: #f1c40f;
        stroke: #b58f00;
        stroke-width: 0.5;
      }
      .fs-perm-off {
        fill: #000000;
        stroke: #333333;
        stroke-width: 0.5;
      }
      .term-input {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 14px;
        border-top: 1px solid #2a2a2a;
        background: #0c0c0c;
      }
      .term-prompt {
        color: inherit;
        white-space: pre;
      }
      .prompt-userhost {
        color: #fce94f;
      } /* yellow */
      .prompt-path {
        color: #ef2929;
      } /* red */
      .prompt-dollar {
        color: #cccccc;
      }
      .ls-dir {
        color: #3b78ff; /* Campbell bright blue */
      }
      .term-instruction {
        font-style: italic;
        margin: 12px 0;
      }
      /* Inline, borderless editing next to the prompt */
      .term-line .term-input-editable {
        display: inline-block;
        min-width: 1ch;
        outline: none;
        border: none;
        background: transparent;
        color: inherit;
        font: inherit;
        white-space: pre;
        caret-color: #cccccc;
      }
      .term-input input {
        flex: 1;
        background: transparent;
        color: #e5e5e5;
        border: none;
        outline: none;
        font: inherit;
        padding: 0;
      }
      .title-line {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="term" id="term">
      <div class="term-header" id="term-header" role="presentation">
        <div class="term-tabs">
          <div
            class="term-tab active"
            id="term-tab-label"
            title="Ubuntu â€” bash"
          >
            Ubuntu â€” bash
          </div>
          <div class="term-tab fs-tab" id="term-tab-fs" title="Filesystem">
            Filesystem
          </div>
        </div>
      </div>
      <div class="term-body" id="term-body">
        <div class="term-screen" id="screen" aria-live="polite"></div>
        <div class="fs-pane" id="fs-pane" aria-label="Filesystem view">
          <div class="fs-breadcrumbs" id="fs-breadcrumbs"></div>
          <svg
            class="fs-map"
            id="fs-view"
            viewBox="0 0 1200 520"
            role="img"
            aria-label="Campus map"
          ></svg>
          <script id="fake-fs-embedded" type="text/plain">
          Harvard-Westlake/

          â”œâ”€â”€ ChalmersHall/
          â”‚   â”œâ”€â”€ LowerLevel/
          â”‚   â”‚   â”œâ”€â”€ DanceStudio/
          â”‚   â”‚   â”‚   â””â”€â”€ schedule.txt â€“ "Mon: Ballet 3:30 PM; Tue: Contemporary 4:00 PM; Wed: Jazz 3:30 PM"
          â”‚   â”‚   â”œâ”€â”€ Bookstore/
          â”‚   â”‚   â”‚   â””â”€â”€ inventory.csv â€“ (Textbook and merchandise stock list)
          â”‚   â”‚   â”œâ”€â”€ MusicRoom1/
          â”‚   â”‚   â”‚   â””â”€â”€ sheet_music.pdf â€“ (Choir sheet music collection)
          â”‚   â”‚   â””â”€â”€ MusicRoom2/
          â”‚   â”‚       â””â”€â”€ practice_schedule.txt â€“ "Band practice: M/W/F 3-5 PM"
          â”‚   â”œâ”€â”€ SecondFloor/
          â”‚   â”‚   â”œâ”€â”€ Cafeteria/
          â”‚   â”‚   â”‚   â”œâ”€â”€ menu.txt â€“ "Monday: Pizza; Tuesday: Tacos; â€¦"
          â”‚   â”‚   â”‚   â””â”€â”€ sandwich_window_menu.txt â€“ "Sandwich Options: Turkey, Ham, Veggie, ..."
          â”‚   â”‚   â”œâ”€â”€ DeansOffices/
          â”‚   â”‚   â”‚   â”œâ”€â”€ DeanOfStudents.txt â€“ "Contact: Dean of Students (email, extension)"
          â”‚   â”‚   â”‚   â”œâ”€â”€ DeanOfFaculty.txt â€“ "Contact: Dean of Faculty (email, extension)"
          â”‚   â”‚   â”‚   â””â”€â”€ ClassDeans.txt â€“ "Grade 10 Dean: ...; Grade 11 Dean: ...; Grade 12 Dean: ..."
          â”‚   â”‚   â””â”€â”€ StudentLounge/
          â”‚   â”‚       â””â”€â”€ notice_board.md â€“ "Upcoming Events: Club Fair Friday; SAT Prep Session Thursday"
          â”‚   â””â”€â”€ ThirdFloor/
          â”‚       â”œâ”€â”€ Chalmers301/
          â”‚       â”‚   â””â”€â”€ syllabus.pdf â€“ (Calculus AB Syllabus)
          â”‚       â”œâ”€â”€ Chalmers305/
          â”‚       â”‚   â””â”€â”€ equation.txt â€“ "e^(iÏ€) + 1 = 0"
          â”‚       â””â”€â”€ Chalmers307/
          â”‚           â””â”€â”€ homework_assignments.docx â€“ ("Algebra II â€“ Problem Set 5" assignment sheet)

          â”œâ”€â”€ SeaverAcademicCenter/
          â”‚   â”œâ”€â”€ FlagCourtLevel/
          â”‚   â”‚   â”œâ”€â”€ FrenchClassroom/
          â”‚   â”‚   â”‚   â””â”€â”€ oral_exam.wav â€“ (Audio recording for French pronunciation exam)
          â”‚   â”‚   â”œâ”€â”€ SpanishClassroom/
          â”‚   â”‚   â”‚   â””â”€â”€ vocab_list.txt â€“ "Unidad 5 Vocab: la casa (house), la mesa (table), â€¦"
          â”‚   â”‚   â”œâ”€â”€ LatinClassroom/
          â”‚   â”‚   â”‚   â””â”€â”€ translation_assignment.docx â€“ ("Translate Vergil lines 1â€“10")
          â”‚   â”‚   â””â”€â”€ ChineseClassroom/
          â”‚   â”‚       â””â”€â”€ characters.pdf â€“ (Worksheet of Chinese characters for study)
          â”‚   â”œâ”€â”€ SecondFloor/
          â”‚   â”‚   â”œâ”€â”€ LearningCenter/
          â”‚   â”‚   â”‚   â””â”€â”€ tutoring_schedule.pdf â€“ ("Math Lab: Mon 3-4 PM; Writing Center: Tue 3-5 PM; â€¦")
          â”‚   â”‚   â”œâ”€â”€ AdminOffices/
          â”‚   â”‚   â”‚   â”œâ”€â”€ HeadOfUpperSchool.txt â€“ "Head of Upper School: Office Hrs M-F 9 AMâ€“11 AM"
          â”‚   â”‚   â”‚   â”œâ”€â”€ AttendanceOffice.txt â€“ "Report absences: attendance@hw.com or x1234"
          â”‚   â”‚   â”‚   â””â”€â”€ AdmissionsOffice.txt â€“ "Admissions Dept â€“ Info Session schedule.docx"
          â”‚   â”‚   â””â”€â”€ VisitorLobby/
          â”‚   â”‚       â””â”€â”€ campus_map.pdf â€“ (Campus map for visitors)
          â”‚   â””â”€â”€ ThirdFloor/
          â”‚       â”œâ”€â”€ Seaver301/
          â”‚       â”‚   â””â”€â”€ syllabus_AP_US_History.docx â€“ (AP U.S. History syllabus document)
          â”‚       â”œâ”€â”€ Seaver303/
          â”‚       â”‚   â””â”€â”€ lecture_notes.md â€“ "# World History Lecture â€“ Industrial Revolution\n... (notes content) ..."
          â”‚       â””â”€â”€ Seaver305/
          â”‚           â””â”€â”€ project_guidelines.pdf â€“ ("Senior Thesis Guidelines" for Social Studies)

          â”œâ”€â”€ MungerScienceCenter/
          â”‚   â”œâ”€â”€ BiologyLab/
          â”‚   â”‚   â””â”€â”€ dissection_schedule.txt â€“ "Frog dissection: Oct 12; Fetal pig: Nov 3; ... "
          â”‚   â”œâ”€â”€ ChemistryLab/
          â”‚   â”‚   â””â”€â”€ safety_rules.md â€“ "* Always wear goggles in the lab. * No open-toed shoes. * ..."
          â”‚   â”œâ”€â”€ PhysicsLab/
          â”‚   â”‚   â””â”€â”€ experiment_data.csv â€“ (CSV data from physics experiment trials)
          â”‚   â”œâ”€â”€ ComputerLab/
          â”‚   â”‚   â””â”€â”€ hello_world.py â€“ `print("Hello, HW!")`
          â”‚   â”œâ”€â”€ RoboticsLab/
          â”‚   â”‚   â””â”€â”€ robot_design.png â€“ (Image of a student robotics project blueprint)
          â”‚   â””â”€â”€ AhmansonLectureHall/
          â”‚       â””â”€â”€ guest_lecture_schedule.txt â€“ "Oct 5: NASA Engineer @ 1PM; Nov 10: Alumni Scientist Talk @ 2PM"

          â”œâ”€â”€ RugbyHall/
          â”‚   â”œâ”€â”€ EnglishDept/
          â”‚   â”‚   â”œâ”€â”€ Rugby101/
          â”‚   â”‚   â”‚   â””â”€â”€ reading_list.txt â€“ "Fall Reading: 1984, Hamlet, The Great Gatsby, â€¦"
          â”‚   â”‚   â”œâ”€â”€ Rugby102/
          â”‚   â”‚   â”‚   â””â”€â”€ essay_prompts.docx â€“ ("Literary Analysis Essay Prompts.docx")
          â”‚   â”‚   â””â”€â”€ FacultyOffice/
          â”‚   â”‚       â””â”€â”€ english_teachers.xlsx â€“ (Spreadsheet of English department faculty and contacts)
          â”‚   â”œâ”€â”€ Auditorium/
          â”‚   â”‚   â”œâ”€â”€ Stage/
          â”‚   â”‚   â”‚   â””â”€â”€ lighting_config.cfg â€“ (Stage lighting configuration settings)
          â”‚   â”‚   â”œâ”€â”€ CostumeShop/
          â”‚   â”‚   â”‚   â””â”€â”€ inventory.txt â€“ "Costumes: 1920s dresses (5), Viking helmets (3), ... "
          â”‚   â”‚   â”œâ”€â”€ PropRoom/
          â”‚   â”‚   â”‚   â””â”€â”€ props_list.txt â€“ "Swords (2), Fake Books (10), Old Telephone (1), â€¦"
          â”‚   â”‚   â””â”€â”€ ControlBooth/
          â”‚   â”‚       â””â”€â”€ sound_equipment.md â€“ "- Mixer Model XYZ\n- Wireless Mics (10)\n- Speakers: 2000W x4\n..."
          â”‚   â””â”€â”€ DramaLab/
          â”‚       â””â”€â”€ script_draft.pdf â€“ (PDF of a student-written one-act play draft)

          â”œâ”€â”€ WeilerHall/
          â”‚   â”œâ”€â”€ ChronicleNewsroom/
          â”‚   â”‚   â””â”€â”€ latest_issue.pdf â€“ (PDF of **The Harvard-Westlake Chronicle** school newspaper)
          â”‚   â””â”€â”€ BroadcastStudio/
          â”‚       â”œâ”€â”€ equipment_list.txt â€“ "Cameras: Canon XA11 (2); Microphones: Shure wireless (4); ... "
          â”‚       â””â”€â”€ broadcast_schedule.txt â€“ "Weekly News Broadcast: Fridays 8 AM on HWTV"

          â”œâ”€â”€ KutlerCenter/
          â”‚   â”œâ”€â”€ KutlerLabs/
          â”‚   â”‚   â”œâ”€â”€ ResearchLab1/
          â”‚   â”‚   â”‚   â””â”€â”€ project_proposal.docx â€“ ("Independent Research Project Proposal.docx")
          â”‚   â”‚   â””â”€â”€ ResearchLab2/
          â”‚   â”‚       â””â”€â”€ data_analysis.py â€“ (Python script for data analysis in a Kutler project)
          â”‚   â””â”€â”€ FeldmanHornArt/
          â”‚       â”œâ”€â”€ ArtStudio1/
          â”‚       â”‚   â””â”€â”€ painting_project.jpg â€“ (JPEG image of a student oil painting)
          â”‚       â”œâ”€â”€ ArtStudio2/
          â”‚       â”‚   â””â”€â”€ clay_sculpture.png â€“ (Image of a ceramic sculpture in progress)
          â”‚       â”œâ”€â”€ DarkRoom/
          â”‚       â”‚   â””â”€â”€ photo_developing_log.txt â€“ "09/15: Developed 5 rolls B&W; 10/01: Chemistry refilled; â€¦"
          â”‚       â”œâ”€â”€ VideoLab/
          â”‚       â”‚   â””â”€â”€ film_edit.mov â€“ (Video file of a student short film edit)
          â”‚       â””â”€â”€ Gallery/
          â”‚           â””â”€â”€ current_exhibit.txt â€“ "Fall Student Art Show â€“ Featuring works from Photography and Studio Art classes"

          â”œâ”€â”€ MuddLibrary/
          â”‚   â”œâ”€â”€ FirstFloor/
          â”‚   â”‚   â”œâ”€â”€ CirculationDesk/
          â”‚   â”‚   â”‚   â””â”€â”€ hours.txt â€“ "Library Hours: M-Th 7:30 AMâ€“6:00 PM; Fri 7:30 AMâ€“5:00 PM"
          â”‚   â”‚   â””â”€â”€ ReadingArea/
          â”‚   â”‚       â””â”€â”€ newspapers_list.txt â€“ "NY Times, LA Times, Wall Street Journal, ... (available daily)"
          â”‚   â”œâ”€â”€ SecondFloor/
          â”‚   â”‚   â”œâ”€â”€ Stacks/
          â”‚   â”‚   â”‚   â”œâ”€â”€ fiction_section.txt â€“ (List of popular novels and their call numbers)
          â”‚   â”‚   â”‚   â””â”€â”€ reference_section.txt â€“ (List of encyclopedias, dictionaries, reference books)
          â”‚   â”‚   â””â”€â”€ StudyArea/
          â”‚   â”‚       â””â”€â”€ computer_stations.csv â€“ (CSV of library computer station IDs and statuses)
          â”‚   â””â”€â”€ ThirdFloor/
          â”‚       â”œâ”€â”€ SilentStudy/
          â”‚       â”‚   â””â”€â”€ rules.md â€“ "be quiet, no food."
          â”‚       â””â”€â”€ StudyRoomA/
          â”‚           â””â”€â”€ reservation_log.txt â€“ "10/10 3-4PM: Booked (Jane D.); 10/10 4-5PM: Available; â€¦"

          â”œâ”€â”€ StSavioursChapel/
          â”‚   â””â”€â”€ schedule.txt â€“ "Chapel open daily 8 AMâ€“4 PM; Meditation Club â€“ Wed 3:30 PM"

          â”œâ”€â”€ DidaxHouse/
          â”‚   â”œâ”€â”€ ITOffice/
          â”‚   â”‚   â””â”€â”€ server_status.log â€“ (System uptime logs and server status messages)
          â”‚   â””â”€â”€ DevTeam/
          â”‚       â””â”€â”€ didax_source_code.py â€“ (Source code snippet of the school's Didax system)

          â”œâ”€â”€ AdvancementHouse/
          â”‚   â””â”€â”€ alumni_events.docx â€“ ("Alumni Reunion 2025 Plan.docx")

          â”œâ”€â”€ BusinessOffice/
          â”‚   â””â”€â”€ budget_fy2025.xlsx â€“ (Spreadsheet of school budget for fiscal year 2024â€“25)

          â”œâ”€â”€ PresidentsOffice/
          â”‚   â””â”€â”€ welcome_letter.md â€“ ("Welcome from the President" message markdown)

          â”œâ”€â”€ TaperAthleticPavilion/
          â”‚   â”œâ”€â”€ MainGym/
          â”‚   â”‚   â””â”€â”€ basketball_schedule.txt â€“ "Varsity Practice M-F 3-5 PM; Home Games listed on athletics.hw.com"
          â”‚   â”œâ”€â”€ WeightRoom/
          â”‚   â”‚   â””â”€â”€ equipment.csv â€“ (Inventory of weight machines and free weights)
          â”‚   â”œâ”€â”€ LockerRoomMen/
          â”‚   â”‚   â””â”€â”€ locker_assignments.txt â€“ (Locker # -> Student athlete name)
          â”‚   â”œâ”€â”€ LockerRoomWomen/
          â”‚   â”‚   â””â”€â”€ locker_assignments.txt â€“ (Locker # -> Student athlete name)
          â”‚   â””â”€â”€ FencingRoom/
          â”‚       â””â”€â”€ practice_times.txt â€“ "Fencing Team: Tue/Thu 4-6 PM"

          â”œâ”€â”€ HamiltonGym/
          â”‚   â””â”€â”€ practice_schedule.txt â€“ "JV Basketball: Mon/Wed 4 PM; Wrestling: Tue/Thu 4 PM; ... "

          â”œâ”€â”€ CopsesPool/
          â”‚   â””â”€â”€ swim_meet_schedule.txt â€“ "Fall Swim Meet: Oct 21 3:00 PM; Water Polo Finals: Nov 5 4:00 PM"

          â””â”€â”€ TedSlavinField/
              â””â”€â”€ track_and_field_schedule.csv â€“ (CSV schedule for track meets and field events)
        </script>
      </div>
      </div>
    </div>

    <script>
      (function () {
        var screen = document.getElementById("screen");
        var input = null; // dynamically created per prompt line
        var activeLineEl = null;
        var term = document.getElementById("term");
        var currentUserhost = "hwwolverine@DESKTOP-WSL";
        var currentPathText = "~/Harvard-Westlake";
        var hideInput = false; // hide echo for secure input (sudo password)
        var activeView = "terminal";
        var fsModel = null;
        var fsExpanded = {};
        var fsCurrentPath = ["Harvard-Westlake"];
        var fsViewPath = ["Harvard-Westlake"]; // current drill-down view
        var fsLastClickedPath = null; // path array of last clicked item in filesystem view
        var fsLastClickedIsFile = false;
        var fsBaselineByDemo = {}; // key -> snapshot of fsModel
        var activeDemoKey = null;
        var hintShown = {}; // one-time hints for visual map
        // Temporary "ls" preview overlay (clears on the next Enter)
        // This is drawn *under the directory you just listed* while staying on the current
        // parent-directory view (so the outlined "current" item remains visible).
        var fsLsPreview = null; // { pathKey: string, pathArr: Array<string>, entries: Array<{name,type}> }

        function cloneFsModel(model) {
          try {
            return JSON.parse(JSON.stringify(model || initFsModel()));
          } catch (e) {
            return initFsModel();
          }
        }
        function suggestHint(key, messageHtml) {
          if (hintShown[key]) return;
          hintShown[key] = true;
          appendInstructionHtml(messageHtml);
        }
        function saveFsBaseline(key) {
          fsBaselineByDemo[key] = cloneFsModel(fsModel);
        }
        function restoreFsBaseline(key) {
          if (!key) return;
          var snap = fsBaselineByDemo[key];
          if (snap) {
            fsModel = cloneFsModel(snap);
            // Re-align current view and current working dir highlight
            fsSetCurrentPathFromPrompt();
            if (activeView === "fs" || activeView === "fs-full") renderFsPane();
          }
        }

        function escapeHtml(s) {
          return String(s)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }
        function getPromptHtml() {
          return (
            '<span class="prompt-userhost">' +
            escapeHtml(currentUserhost) +
            "</span>:" +
            '<span class="prompt-path">' +
            escapeHtml(currentPathText) +
            "</span>" +
            '<span class="prompt-dollar">$</span>'
          );
        }
        function updateTabLabel() {
          var el = document.getElementById("term-tab-label");
          if (!el) return;
          var labelText = currentUserhost + ":" + currentPathText + "$";
          el.textContent = labelText;
          el.setAttribute("title", labelText);
        }
        function fsPathKey(arr) {
          return (arr || []).join("/");
        }
        function fsParentPath(pathArr) {
          var a = (pathArr || []).slice();
          if (a.length <= 1) return a;
          return a.slice(0, -1);
        }
        function initFsModel() {
          if (fsModel) return fsModel;
          // Minimal placeholder; real model loaded from fakeFileSystem.md
          fsModel = { type: "dir", name: "Harvard-Westlake", children: {} };
          fsExpanded = { "Harvard-Westlake": true };
          return fsModel;
        }
        function parseFakeFilesystemAscii(text) {
          var lines = (text || "").split(/\r?\n/);
          var root = null;
          var stack = []; // each entry: {depth, node}
          function makeDir(name) {
            return {
              type: "dir",
              name: name,
              mode: "drwxr-xr-x",
              owner: "hw_admin",
              group: "faculty",
              children: {},
            };
          }
          function makeFile(name) {
            return {
              type: "file",
              name: name,
              mode: "-rw-r--r--",
              owner: "hw_admin",
              group: "faculty",
            };
          }
          function addChild(parent, child) {
            if (!parent.children) parent.children = {};
            parent.children[child.name] = child;
          }
          function computeDepth(prefix) {
            // Count groups of 4 chars, treating pipes as spaces
            var s = prefix.replace(/â”‚/g, " ");
            return Math.floor(s.length / 4);
          }
          for (var i = 0; i < lines.length; i++) {
            var raw = lines[i];
            if (!raw || !raw.trim()) continue;
            var line = raw.replace(/\t/g, "    ");
            // Root line like 'Harvard-Westlake/'
            if (!root && /\/\s*$/.test(line.trim())) {
              var rootName = line.trim().replace(/\/\s*$/, "");
              root = makeDir(rootName);
              stack = [{ depth: 0, node: root }];
              continue;
            }
            var m = /(.*?)(â”œâ”€â”€ |â””â”€â”€ )(.+)$/.exec(line);
            if (!m) continue;
            var prefix = m[1] || "";
            var nameAndMeta = m[3].trim();
            var nameOnly = nameAndMeta.split(/\s[â€“-]\s/)[0].trim();
            var isDir = /\/\s*$/.test(nameOnly);
            var cleanName = nameOnly.replace(/\/\s*$/, "");
            var depth = computeDepth(prefix) + 1; // child of current depth
            while (stack.length && stack[stack.length - 1].depth >= depth) {
              stack.pop();
            }
            var parent = stack.length ? stack[stack.length - 1].node : root;
            if (!parent) continue;
            var node = isDir ? makeDir(cleanName) : makeFile(cleanName);
            addChild(parent, node);
            stack.push({ depth: depth, node: node });
          }
          return root;
        }
        function fsNodeByPath(arr) {
          var node = initFsModel();
          var parts = (arr || []).slice();
          if (!parts.length || parts[0] !== "Harvard-Westlake") {
            parts.unshift("Harvard-Westlake");
          }
          for (var i = 1; i < parts.length; i++) {
            if (!node.children || !node.children[parts[i]]) return null;
            node = node.children[parts[i]];
          }
          return node;
        }
        function trimRootSingleFileDirs(keepCount) {
          var root = initFsModel();
          if (!root || !root.children) return;
          var names = Object.keys(root.children).sort();
          var simple = [];
          for (var i = 0; i < names.length; i++) {
            var child = root.children[names[i]];
            if (!child || child.type !== "dir") continue;
            var kids = child.children || {};
            var kidNames = Object.keys(kids);
            if (kidNames.length === 1) {
              var only = kids[kidNames[0]];
              if (only && only.type === "file") {
                simple.push(names[i]);
              }
            }
          }
          if (simple.length > keepCount) {
            // Keep the first one alphabetically; trim the rest
            for (var j = keepCount; j < simple.length; j++) {
              delete root.children[simple[j]];
            }
          }
        }
        function fsSetCurrentPathFromPrompt() {
          var t = currentPathText || "~/Harvard-Westlake";
          var p = t.replace(/^~\//, "");
          if (p === "~") p = "Harvard-Westlake";
          var parts = p.split("/").filter(Boolean);
          if (!parts.length || parts[0] !== "Harvard-Westlake")
            parts.unshift("Harvard-Westlake");
          fsCurrentPath = parts;
          // Always show the parent directory in the filesystem graphic, so the current directory
          // appears as a highlighted child among its siblings.
          fsViewPath = fsParentPath(parts);
          var acc = [];
          for (var i = 0; i < parts.length; i++) {
            acc.push(parts[i]);
            fsExpanded[fsPathKey(acc)] = true;
          }
          if (activeView === "fs" || activeView === "fs-full") renderFsPane();
        }

        function fsGetDirEntries(pathArr) {
          var node = fsNodeByPath(pathArr);
          var out = [];
          if (!node || node.type !== "dir") return out;
          var kids = node.children || {};
          var names = Object.keys(kids).sort();
          for (var i = 0; i < names.length; i++) {
            var k = kids[names[i]];
            var type = (k && k.type) || "file";
            out.push({
              name: names[i],
              type: type,
              mode:
                (k && k.mode) ||
                (type === "dir" ? "drwxr-xr-x" : "-rw-r--r--"),
              owner: (k && k.owner) || "hw_admin",
              group: (k && k.group) || "faculty",
            });
          }
          return out;
        }

        function fsShowLsPreview(pathArr, opts) {
          var p = (pathArr && pathArr.length ? pathArr.slice() : fsCurrentPath.slice());
          // Don't show the green preview for the root directory.
          if (p.length === 1 && p[0] === "Harvard-Westlake") {
            return;
          }
          var entries = fsGetDirEntries(p);
          fsLsPreview = {
            pathKey: fsPathKey(p),
            pathArr: p,
            entries: entries,
            long: !!(opts && opts.long),
          };
          if (activeView === "fs" || activeView === "fs-full") renderFsPane();
        }

        function fsClearLsPreview() {
          if (!fsLsPreview) return;
          fsLsPreview = null;
          if (activeView === "fs" || activeView === "fs-full") renderFsPane();
        }
        function renderNode(node, pathArr) {
          var key = fsPathKey(pathArr);
          var isDir = node.type === "dir";
          var isExpanded = !!fsExpanded[key];
          var isCurrent = key === fsPathKey(fsCurrentPath);
          var nameHtml =
            '<div class="fs-item ' +
            (isDir ? "fs-dir" : "fs-file") +
            (isExpanded ? " expanded" : "") +
            (isCurrent ? " fs-current" : "") +
            '">' +
            '<span class="name" data-path="' +
            escapeHtml(key) +
            '">' +
            escapeHtml(node.name) +
            "</span>" +
            (node.mode
              ? '<span class="fs-meta">' +
                escapeHtml(
                  node.mode +
                    " " +
                    (node.owner || "") +
                    " " +
                    (node.group || "")
                ) +
                "</span>"
              : "") +
            "</div>";
          var childrenHtml = "";
          if (isDir && isExpanded) {
            childrenHtml += '<div class="fs-children">';
            var names = Object.keys(node.children || {}).sort();
            for (var i = 0; i < names.length; i++) {
              var child = node.children[names[i]];
              childrenHtml += renderNode(child, pathArr.concat([names[i]]));
            }
            childrenHtml += "</div>";
          }
          return nameHtml + childrenHtml;
        }
        function renderBreadcrumbs() {
          var bc = document.getElementById("fs-breadcrumbs");
          if (!bc) return;
          var parts = fsViewPath.slice();
          var html = "";
          for (var i = 0; i < parts.length; i++) {
            if (i > 0) html += '<span class="sep">/</span>';
            html +=
              '<span class="crumb" data-index="' +
              i +
              '">' +
              escapeHtml(parts[i]) +
              "</span>";
          }
          bc.innerHTML = html;
          bc.onclick = function (e) {
            var t = e.target;
            if (!t.classList.contains("crumb")) return;
            var idx = parseInt(t.getAttribute("data-index") || "0", 10);
            var nextPath = fsViewPath.slice(0, idx + 1);
            fsLastClickedPath = nextPath.slice();
            fsLastClickedIsFile = false;
            currentPathText = "~/" + nextPath.join("/");
            updatePrompt(currentUserhost, currentPathText);
          };
        }
        function layoutTreemap(nodes, x, y, w, h, horizontal) {
          var out = [];
          var n = nodes && nodes.length ? nodes.length : 0;
          if (!n) return out;
          for (var i = 0; i < n; i++) {
            var nx, ny, nw, nh;
            if (horizontal) {
              nw = Math.max(40, Math.floor(w / n));
              nh = h;
              nx = x + i * nw;
              ny = y;
            } else {
              nw = w;
              nh = Math.max(40, Math.floor(h / n));
              nx = x;
              ny = y + i * nh;
            }
            out.push({ node: nodes[i], x: nx, y: ny, w: nw, h: nh });
          }
          return out;
        }
        function countDesc(node) {
          if (!node || node.type !== "dir") return 1;
          var sum = 1;
          var names = Object.keys(node.children || {});
          for (var i = 0; i < names.length; i++) {
            sum += countDesc(node.children[names[i]]);
          }
          return sum;
        }
        function svgEl(name) {
          return document.createElementNS("http://www.w3.org/2000/svg", name);
        }
        function drawRootAndBranches(svg, labelText, parentBox, childAnchors, parentPathArr) {
          // Draw connectors behind the child boxes.
          if (!childAnchors || !childAnchors.length) return;
          var g = svgEl("g");
          g.setAttribute("opacity", "0.95");
          svg.appendChild(g);

          var stroke = "#1E66F5";
          var strokeW = 6;

          var px = parentBox.x + parentBox.w / 2;
          var pyBottom = parentBox.y + parentBox.h;

          // Place the "bus" line slightly above the children
          var busY = Math.max(
            pyBottom + 24,
            Math.min.apply(
              null,
              childAnchors.map(function (c) {
                return c.y;
              })
            ) - 18
          );

          // Trunk (parent -> bus)
          var trunk = svgEl("line");
          trunk.setAttribute("x1", px);
          trunk.setAttribute("y1", pyBottom);
          trunk.setAttribute("x2", px);
          trunk.setAttribute("y2", busY);
          trunk.setAttribute("stroke", stroke);
          trunk.setAttribute("stroke-width", strokeW);
          trunk.setAttribute("stroke-linecap", "round");
          g.appendChild(trunk);

          // Bus (across all children)
          var minX = Math.min.apply(
            null,
            childAnchors.map(function (c) {
              return c.x;
            })
          );
          var maxX = Math.max.apply(
            null,
            childAnchors.map(function (c) {
              return c.x;
            })
          );
          var bus = svgEl("line");
          bus.setAttribute("x1", minX);
          bus.setAttribute("y1", busY);
          bus.setAttribute("x2", maxX);
          bus.setAttribute("y2", busY);
          bus.setAttribute("stroke", stroke);
          bus.setAttribute("stroke-width", strokeW);
          bus.setAttribute("stroke-linecap", "round");
          g.appendChild(bus);

          // Branches (bus -> each child)
          for (var i = 0; i < childAnchors.length; i++) {
            var c = childAnchors[i];
            var br = svgEl("line");
            br.setAttribute("x1", c.x);
            br.setAttribute("y1", busY);
            br.setAttribute("x2", c.x);
            br.setAttribute("y2", c.y);
            br.setAttribute("stroke", stroke);
            br.setAttribute("stroke-width", strokeW);
            br.setAttribute("stroke-linecap", "round");
            g.appendChild(br);
          }

          // Parent node box + roof (directory)
          var pg = svgEl("g");
          svg.appendChild(pg);
          var base = svgEl("rect");
          base.setAttribute("x", parentBox.x);
          base.setAttribute("y", parentBox.y + 12);
          base.setAttribute("width", parentBox.w);
          base.setAttribute("height", parentBox.h - 12);
          base.setAttribute("rx", 8);
          base.setAttribute("ry", 8);
          base.setAttribute("fill", "#2a2a2a");
          base.setAttribute("stroke", "#555");
          base.setAttribute("stroke-width", "1.2");
          pg.appendChild(base);

          var roof = svgEl("polygon");
          var rx1 = parentBox.x,
            ry1 = parentBox.y + 12;
          var rx2 = parentBox.x + parentBox.w,
            ry2 = parentBox.y + 12;
          var rxm = parentBox.x + parentBox.w / 2,
            rym = parentBox.y + 2;
          roof.setAttribute(
            "points",
            rx1 + "," + ry1 + " " + rx2 + "," + ry2 + " " + rxm + "," + rym
          );
          roof.setAttribute("fill", "#3a3a3a");
          roof.setAttribute("stroke", "#666");
          roof.setAttribute("stroke-width", "1.2");
          pg.appendChild(roof);

          var label = svgEl("text");
          label.setAttribute("x", parentBox.x + parentBox.w / 2);
          label.setAttribute("y", parentBox.y + 32);
          label.setAttribute("text-anchor", "middle");
          label.setAttribute("dominant-baseline", "central");
          label.setAttribute("fill", "#ffffff");
          label.setAttribute("font-size", "16");
          label.textContent = labelText;
          pg.appendChild(label);

          // Clicking the parent node navigates "up" one level (cd into this parent directory),
          // so the next graphic shows the previous parent directory.
          var goToParentDir = function () {
            var next = (parentPathArr && parentPathArr.length ? parentPathArr.slice() : fsViewPath.slice());
            fsLastClickedPath = next.slice();
            fsLastClickedIsFile = false;
            currentPathText = "~/" + next.join("/");
            updatePrompt(currentUserhost, currentPathText);
          };
          base.style.cursor = "pointer";
          roof.style.cursor = "pointer";
          label.style.cursor = "pointer";
          base.addEventListener("click", goToParentDir);
          roof.addEventListener("click", goToParentDir);
          label.addEventListener("click", goToParentDir);
        }

        function drawLsPreviewOverlay(svg, anchorBox, entries, isLong) {
          if (!svg || !anchorBox || !entries) return;
          var shown = entries.slice(0, 10);
          if (!shown.length) return;

          var g = svgEl("g");
          g.setAttribute("id", "fs-ls-preview");
          g.setAttribute("opacity", "0.95");
          svg.appendChild(g);

          var green = "#4dff7a";
          var blue = "#4da3ff";
          var yellow = "#ffd54a";

          var lineH = 26;
          var px = anchorBox.x + anchorBox.w / 2;
          var pyBottom = anchorBox.y + anchorBox.h;

          // Green directory list INSIDE the red box representing the directory.
          // (No "inner" label; just the directory names.)
          var innerDirs = isLong
            ? (entries || []).slice()
            : (entries || []).filter(function (e) {
                return e && e.type === "dir";
              });
          // Render directory names inside the box, clipped so it stays within.
          if (innerDirs.length) {
            var list = innerDirs.slice(0, 20);
            // Estimate how many lines can fit inside the box.
            var innerPad = 8;
            // Start the list in the lower portion of the box so it stays underneath the emoji badges.
            var listLineH = 16;
            var listTopMin = anchorBox.y + Math.floor(anchorBox.h * 0.62);
            var maxLines = Math.max(
              0,
              Math.floor((anchorBox.y + anchorBox.h - innerPad - listTopMin) / listLineH)
            );
            var shownLines = Math.min(list.length, Math.max(0, Math.min(8, maxLines)));
            if (shownLines > 0) {
              var clipId = "fs-ls-clip-" + Math.floor(Math.random() * 1e9);
              var defs = svgEl("defs");
              var clip = svgEl("clipPath");
              clip.setAttribute("id", clipId);
              var clipRect = svgEl("rect");
              clipRect.setAttribute("x", anchorBox.x + innerPad);
              clipRect.setAttribute("y", listTopMin);
              clipRect.setAttribute("width", Math.max(0, anchorBox.w - innerPad * 2));
              clipRect.setAttribute(
                "height",
                Math.max(0, anchorBox.y + anchorBox.h - innerPad - listTopMin)
              );
              clip.appendChild(clipRect);
              defs.appendChild(clip);
              g.appendChild(defs);

              var tg = svgEl("g");
              tg.setAttribute("clip-path", "url(#" + clipId + ")");
              g.appendChild(tg);

              for (var di = 0; di < shownLines; di++) {
                var d = list[di];
                var ty = listTopMin + di * listLineH;
                var t = svgEl("text");
                t.setAttribute("x", anchorBox.x + innerPad);
                t.setAttribute("y", ty);
                t.setAttribute("fill", green);
                t.setAttribute("font-size", "12");
                t.setAttribute("dominant-baseline", "hanging");
                t.setAttribute(
                  "font-family",
                  "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace"
                );
                if (isLong) {
                  var meta =
                    (d.mode || "") +
                    " " +
                    (d.owner || "") +
                    " " +
                    (d.group || "") +
                    " ";
                  t.textContent = (meta + (d.name || "")).trim();
                } else {
                  t.textContent = d.name;
                }
                tg.appendChild(t);
              }

              if (innerDirs.length > shownLines) {
                var more = svgEl("text");
                more.setAttribute("x", anchorBox.x + innerPad);
                more.setAttribute("y", listTopMin + shownLines * listLineH);
                more.setAttribute("fill", green);
                more.setAttribute("font-size", "12");
                more.setAttribute("dominant-baseline", "hanging");
                more.setAttribute(
                  "font-family",
                  "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace"
                );
                more.textContent = "â€¦+" + (innerDirs.length - shownLines);
                tg.appendChild(more);
              }
            }
          }

          var busY = pyBottom + 22;
          var startY = busY + 26;

          // Trunk (from the listed directory down to the bus)
          var trunk = svgEl("line");
          trunk.setAttribute("x1", px);
          trunk.setAttribute("y1", pyBottom);
          trunk.setAttribute("x2", px);
          trunk.setAttribute("y2", busY);
          trunk.setAttribute("stroke", green);
          trunk.setAttribute("stroke-width", "5");
          trunk.setAttribute("stroke-linecap", "round");
          g.appendChild(trunk);

          // Child anchor points: spread slightly horizontally for a "tree" feel
          var anchors = [];
          if (shown.length === 1) {
            anchors.push({ x: px, y: startY });
          } else {
            // Spread anchors equally with a minimum spacing so labels remain readable.
            var minSpacing = 90;
            var maxSpread = 520;
            var spread = Math.min(
              maxSpread,
              Math.max(180, (shown.length - 1) * minSpacing)
            );
            for (var i = 0; i < shown.length; i++) {
              var t = i / (shown.length - 1);
              var x = px - spread / 2 + t * spread;
              anchors.push({ x: x, y: startY + i * lineH });
            }
          }

          // Bus (across anchors)
          var minX = Math.min.apply(
            null,
            anchors.map(function (a) {
              return a.x;
            })
          );
          var maxX = Math.max.apply(
            null,
            anchors.map(function (a) {
              return a.x;
            })
          );
          var bus = svgEl("line");
          bus.setAttribute("x1", minX);
          bus.setAttribute("y1", busY);
          bus.setAttribute("x2", maxX);
          bus.setAttribute("y2", busY);
          bus.setAttribute("stroke", green);
          bus.setAttribute("stroke-width", "5");
          bus.setAttribute("stroke-linecap", "round");
          g.appendChild(bus);

          // Branches + labels
          for (var i = 0; i < anchors.length; i++) {
            var a = anchors[i];
            var br = svgEl("line");
            br.setAttribute("x1", a.x);
            br.setAttribute("y1", busY);
            br.setAttribute("x2", a.x);
            br.setAttribute("y2", a.y);
            br.setAttribute("stroke", green);
            br.setAttribute("stroke-width", "4");
            br.setAttribute("stroke-linecap", "round");
            g.appendChild(br);

            var dot = svgEl("circle");
            dot.setAttribute("cx", a.x);
            dot.setAttribute("cy", a.y);
            dot.setAttribute("r", "3");
            dot.setAttribute("fill", green);
            g.appendChild(dot);

            var label = svgEl("text");
            // Put the name at the end of the green branch (centered under the endpoint dot)
            label.setAttribute("x", a.x);
            label.setAttribute("y", a.y + 18);
            label.setAttribute("font-size", "14");
            label.setAttribute("text-anchor", "middle");
            label.setAttribute("dominant-baseline", "hanging");
            label.setAttribute(
              "font-family",
              "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace"
            );
            label.setAttribute("fill", shown[i].type === "dir" ? blue : yellow);
            label.textContent = shown[i].name;
            g.appendChild(label);
          }

          // Small tag so it's obvious this is a preview
          var tag = svgEl("text");
          tag.setAttribute("x", px + 8);
          tag.setAttribute("y", pyBottom + 16);
          tag.setAttribute("fill", green);
          tag.setAttribute("font-size", "12");
          tag.setAttribute(
            "font-family",
            "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace"
          );
          tag.textContent = "ls";
          g.appendChild(tag);
        }
        function renderFsView() {
          var svg = document.getElementById("fs-view");
          if (!svg) return;
          var root = fsNodeByPath(fsViewPath) || initFsModel();
          while (svg.firstChild) svg.removeChild(svg.firstChild);
          var width = 1200;
          var height = 520;
          var names = Object.keys((root && root.children) || {}).sort();
          var children = names.map(function (n) {
            return root.children[n];
          });
          if (!children.length) {
            // Avoid crashing before the filesystem model loads; show a lightweight placeholder.
            var t = document.createElementNS("http://www.w3.org/2000/svg", "text");
            t.setAttribute("x", "20");
            t.setAttribute("y", "32");
            t.setAttribute("fill", "#e0e0e0");
            t.setAttribute("font-size", "16");
            t.textContent = "Loading filesystemâ€¦";
            svg.appendChild(t);
            return;
          }
          // Add a parent directory node (current view) with connectors down to each child.
          // This makes the directory-tree relationship explicit in every filesystem view.
          var parentLabel =
            (root && root.name) ||
            (fsViewPath && fsViewPath.length ? fsViewPath[fsViewPath.length - 1] : "Harvard-Westlake");
          if (!fsViewPath || !fsViewPath.length) parentLabel = "Harvard-Westlake";
          // Keep the top-level root name consistent.
          if (fsViewPath && fsViewPath.length === 1) parentLabel = "Harvard-Westlake";

          var parentW = Math.min(520, Math.max(260, Math.floor(width * 0.36)));
          var parentH = 68;
          var parentX = Math.floor((width - parentW) / 2);
          var parentY = 10;

          // Shift children down to make space for the parent and connector lines.
          var childTop = parentY + parentH + 56;
          var slices = layoutTreemap(
            children,
            10,
            childTop,
            width - 20,
            Math.max(40, height - childTop - 10),
            true
          );

          var anchors = [];
          for (var i = 0; i < slices.length; i++) {
            var s = slices[i];
            var cw = s.w - 6;
            anchors.push({
              x: s.x + Math.max(40, cw) / 2,
              y: s.y + 8
            });
          }
          drawRootAndBranches(
            svg,
            parentLabel,
            { x: parentX, y: parentY, w: parentW, h: parentH },
            anchors,
            fsViewPath.slice()
          );
          for (var i = 0; i < slices.length; i++) {
            var s = slices[i];
            drawBlock(
              svg,
              s.node,
              fsViewPath.concat([s.node.name]),
              s.x,
              s.y,
              s.w - 6,
              s.h - 6,
              0,
              1
            );
          }

          // If the user just ran `ls`, overlay a temporary preview (clears on the next Enter).
          // We stay on the current parent-directory view and attach the branches under the listed item.
          if (fsLsPreview && fsLsPreview.pathArr && fsLsPreview.entries) {
            var p = fsLsPreview.pathArr.slice();
            var parent = fsParentPath(p);
            if (fsPathKey(parent) === fsPathKey(fsViewPath)) {
              // The listed directory should be visible as a child box in this view.
              var childName = p[p.length - 1];
              var anchor = null;
              for (var i = 0; i < slices.length; i++) {
                var s = slices[i];
                if (s && s.node && s.node.name === childName) {
                  anchor = { x: s.x, y: s.y, w: s.w - 6, h: s.h - 6 };
                  break;
                }
              }
              // Fallback: if the child isn't found (unexpected), attach under the view root.
              if (!anchor) anchor = { x: parentX, y: parentY, w: parentW, h: parentH };
              drawLsPreviewOverlay(svg, anchor, fsLsPreview.entries, !!fsLsPreview.long);
            }
          }
        }
        function drawPermBadges(g, mode, x, y, w, h) {
          if (!mode || mode.length < 10) return;
          var owner = mode.slice(1, 4);
          var group = mode.slice(4, 7);
          var other = mode.slice(7, 10);
          var rows = [owner, group, other]; // top-to-bottom labels handled by icons
          var cols = ["r", "w", "x"];
          // Layout inside box
          var topMargin = 26;
          var bottomMargin = 10;
          var leftLabel = 26;
          var rightMargin = 10;
          var gridW = Math.max(0, w - leftLabel - rightMargin);
          var gridH = Math.max(0, h - topMargin - bottomMargin);
          var cell = Math.max(
            12,
            Math.min(24, Math.floor(Math.min(gridW, gridH) / 5))
          );
          if (cell < 12) return;
          var pad = Math.floor(cell * 0.25);
          var colHeaderY = y + topMargin + Math.floor(cell * 0.6);
          var rowStartY = y + topMargin + cell + pad * 2;
          var colStartX = x + leftLabel + pad * 2;
          // Column headers: ðŸ‘‘, ðŸ‘¥, ðŸ•µï¸
          var colIcons = ["ðŸ‘‘", "ðŸ‘¥", "ðŸ•µï¸"];
          for (var c = 0; c < 3; c++) {
            var tx = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "text"
            );
            tx.setAttribute("x", colStartX + c * (cell + pad) + cell / 2);
            tx.setAttribute("y", colHeaderY);
            tx.setAttribute("text-anchor", "middle");
            tx.setAttribute("dominant-baseline", "central");
            tx.setAttribute("fill", "#e6e6e6");
            tx.setAttribute("font-size", Math.floor(cell * 0.8));
            tx.textContent = colIcons[c];
            g.appendChild(tx);
          }
          // Row headers: ðŸ“–, âœï¸, âº
          var rowIcons = ["ðŸ“–", "âœï¸", "âº"];
          for (var r = 0; r < 3; r++) {
            var ty = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "text"
            );
            ty.setAttribute("x", x + Math.floor(leftLabel / 2));
            ty.setAttribute("y", rowStartY + r * (cell + pad) + cell / 2);
            ty.setAttribute("text-anchor", "middle");
            ty.setAttribute("dominant-baseline", "central");
            ty.setAttribute("fill", r === 2 ? "#e53935" : "#e6e6e6");
            ty.setAttribute("font-size", Math.floor(cell * 0.9));
            ty.textContent = rowIcons[r];
            g.appendChild(ty);
          }
          // Grid cells
          for (var rr = 0; rr < 3; rr++) {
            for (var cc = 0; cc < 3; cc++) {
              var on = rows[rr].indexOf(cols[cc]) !== -1;
              var rect = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "rect"
              );
              rect.setAttribute("x", colStartX + cc * (cell + pad));
              rect.setAttribute("y", rowStartY + rr * (cell + pad));
              rect.setAttribute("width", cell);
              rect.setAttribute("height", cell);
              rect.setAttribute("class", on ? "fs-perm-on" : "fs-perm-off");
              g.appendChild(rect);
            }
          }
        }
        function drawBlock(svg, node, pathArr, x, y, w, h, depth, maxDepth) {
          var g = document.createElementNS("http://www.w3.org/2000/svg", "g");
          svg.appendChild(g);
          var isCurrent = fsPathKey(pathArr) === fsPathKey(fsCurrentPath);
          if (node.type === "dir") {
            var bw = Math.max(40, w);
            var bh = Math.max(28, h - 12);
            // Building base
            var base = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "rect"
            );
            base.setAttribute("x", x);
            base.setAttribute("y", y + 12);
            base.setAttribute("width", bw);
            base.setAttribute("height", bh);
            base.setAttribute(
              "class",
              "fs-building" + (isCurrent ? " current" : "")
            );
            base.setAttribute("rx", 6);
            base.setAttribute("ry", 6);
            g.appendChild(base);
            // Roof
            var roof = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "polygon"
            );
            var rx1 = x,
              ry1 = y + 12;
            var rx2 = x + bw,
              ry2 = y + 12;
            var rxm = x + bw / 2,
              rym = y + 2;
            roof.setAttribute(
              "points",
              rx1 + "," + ry1 + " " + rx2 + "," + ry2 + " " + rxm + "," + rym
            );
            roof.setAttribute("class", "fs-roof");
            g.appendChild(roof);
            // Click to "cd" into this directory (the graphic continues to show the parent directory).
            var cdIntoDir = function () {
              fsLastClickedPath = pathArr.slice();
              fsLastClickedIsFile = false;
              currentPathText = "~/" + pathArr.join("/");
              updatePrompt(currentUserhost, currentPathText);
            };
            base.addEventListener("click", cdIntoDir);
            roof.addEventListener("click", cdIntoDir);
          } else {
            var sw = Math.max(36, w);
            var sh = Math.max(36, h - 6);
            // File sheet with folded corner
            var sheet = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "rect"
            );
            sheet.setAttribute("x", x);
            sheet.setAttribute("y", y + 6);
            sheet.setAttribute("width", sw);
            sheet.setAttribute("height", sh);
            sheet.setAttribute(
              "class",
              "fs-file" + (isCurrent ? " current" : "")
            );
            g.appendChild(sheet);
            var fold = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "polygon"
            );
            var fx = x + Math.max(24, Math.min(sw - 8, 28));
            var fy = y + 6;
            fold.setAttribute(
              "points",
              fx +
                "," +
                fy +
                " " +
                (fx + 10) +
                "," +
                (fy + 0) +
                " " +
                (fx + 10) +
                "," +
                (fy + 10)
            );
            fold.setAttribute("class", "fs-file-fold");
            g.appendChild(fold);
            var setCwd = function () {
              fsLastClickedPath = pathArr.slice();
              fsLastClickedIsFile = true;
              var parent = pathArr.slice(0, -1);
              currentPathText = "~/" + parent.join("/");
              updatePrompt(currentUserhost, currentPathText);
            };
            sheet.addEventListener("click", setCwd);
            fold.addEventListener("click", setCwd);
          }
          // Label
          var label = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text"
          );
          label.setAttribute("x", x + 8);
          label.setAttribute("y", y + 22);
          label.setAttribute("fill", "#ffffff");
          label.textContent = node.name;
          g.appendChild(label);
          // Artistic permission badges (spread within the box)
          drawPermBadges(
            g,
            node.mode,
            x,
            y + 6,
            node.type === "dir" ? Math.max(40, w) : Math.max(36, w),
            Math.max(40, h - 6)
          );
          if (
            node.type === "dir" &&
            (maxDepth === undefined || depth + 1 < maxDepth)
          ) {
            var names = Object.keys(node.children || {}).sort();
            if (names.length > 0) {
              var innerNodes = names.map(function (n) {
                return { name: n, node: node.children[n] };
              });
              var horiz = depth % 2 === 0 ? false : true;
              var slices = layoutTreemap(
                innerNodes.map(function (x) {
                  return x.node;
                }),
                x + 8,
                y + 24,
                Math.max(24, w - 16),
                Math.max(10, h - 32),
                horiz
              );
              for (var i = 0; i < slices.length; i++) {
                var s = slices[i];
                drawBlock(
                  svg,
                  s.node,
                  pathArr.concat([s.node.name]),
                  s.x,
                  s.y,
                  s.w - 4,
                  s.h - 4,
                  depth + 1,
                  maxDepth
                );
              }
            }
          }
        }
        function renderFsPane() {
          renderBreadcrumbs();
          renderFsView();
        }
        function setView(view) {
          activeView = view;
          var screenEl = document.getElementById("screen");
          var fsEl = document.getElementById("fs-pane");
          var bodyEl = document.getElementById("term-body");
          var tabTerm = document.getElementById("term-tab-label");
          var tabFs = document.getElementById("term-tab-fs");
          if (view === "terminal") {
            if (bodyEl) bodyEl.classList.remove("fs-fullscreen");
            screenEl.style.display = "block";
            fsEl.style.display = "none";
            tabTerm.classList.add("active");
            tabFs.classList.remove("active");
          } else if (view === "fs-full") {
            if (bodyEl) bodyEl.classList.add("fs-fullscreen");
            screenEl.style.display = "none";
            fsEl.style.display = "block";
            tabTerm.classList.remove("active");
            tabFs.classList.add("active");
            renderFsPane();
          } else {
            // Split view: keep the terminal visible on the left and show the filesystem on the right
            if (bodyEl) bodyEl.classList.remove("fs-fullscreen");
            screenEl.style.display = "block";
            fsEl.style.display = "block";
            tabTerm.classList.remove("active");
            tabFs.classList.add("active");
            renderFsPane();
          }
        }
        function appendLine(text) {
          screen.insertAdjacentHTML(
            "beforeend",
            '<div class="term-line">' + escapeHtml(text) + "</div>"
          );
          screen.scrollTop = screen.scrollHeight;
        }
        function appendRawLine(html) {
          screen.insertAdjacentHTML(
            "beforeend",
            '<div class="term-line">' + html + "</div>"
          );
          screen.scrollTop = screen.scrollHeight;
        }
        function appendInstructionHtml(html) {
          screen.insertAdjacentHTML(
            "beforeend",
            '<div class="term-instruction"><em>' + html + "</em></div>"
          );
          screen.scrollTop = screen.scrollHeight;
        }
        function updatePrompt(userhost, pathText) {
          currentUserhost = userhost;
          currentPathText = pathText;
          // Update the visible current prompt, if present
          if (activeLineEl) {
            var promptSpan = activeLineEl.querySelector(".term-prompt");
            if (promptSpan) promptSpan.innerHTML = getPromptHtml();
          }
          updateTabLabel();
          fsSetCurrentPathFromPrompt();
        }
        function createInputLine() {
          var line = document.createElement("div");
          line.className = "term-line";
          line.innerHTML =
            '<span class="term-prompt">' +
            getPromptHtml() +
            "</span> " +
            '<span class="term-input-editable" contenteditable="true" spellcheck="false" role="textbox" aria-label="Terminal command input"></span>';
          screen.appendChild(line);
          activeLineEl = line;
          input = line.querySelector(".term-input-editable");
          input.addEventListener("keydown", onKeyDown);
          screen.scrollTop = screen.scrollHeight;
          input.focus();
        }
        function finalizeCurrentInput(raw) {
          if (!activeLineEl) return;
          var promptHtml =
            '<span class="term-prompt">' + getPromptHtml() + "</span>";
          var suffix = "";
          if (!hideInput && raw && raw.length) {
            suffix = " " + escapeHtml(raw);
          }
          activeLineEl.innerHTML = promptHtml + suffix;
          activeLineEl = null;
          input = null;
        }

        // Focus input on load and on screen click
        window.addEventListener("load", function () {
          if (input) input.focus();
        });
        term.addEventListener("click", function () {
          if (input) input.focus();
        });

        // ===== Lesson Content (HTML, bold preserved) =====
        var textSections = [
          [
            "A <strong>file</strong> contains data that your operating system (Windows, Linux, macOS, etc.) stores. A <strong>directory</strong> is a special kind of record that stores a list of names and references to those files and/or other directories so the system can organize everything. Imagine in a school, a file is a single room that holds its materials. A directory is a hallway that leads to or contains rooms, as well as branches off into other hallways. This system of rooms and hallways is a <strong>tree</strong>. In a Harvard-Westlake school metaphor, the school campus is the root of the tree, which branches out into buildings (Chalmers, Seaver, etc.), and then further into rooms (Student Lounge) and hallways (Upper Chalmers), that contain their own rooms (Chalmers 305)." +
              "<div role='img' aria-label='A hallway line connecting rooms (files) in a directory' style='margin:14px 0 6px; display:flex; justify-content:center;'>" +
              "<svg id='hallway-cursor-svg' width='560' height='180' viewBox='0 0 560 180' xmlns='http://www.w3.org/2000/svg'>" +
              "<rect x='20' y='72' width='70' height='55' rx='10' fill='#FFEB3B' stroke='#C7A600' stroke-width='2'/>" +
              "<text x='55' y='100' font-size='34' text-anchor='middle' dominant-baseline='middle'>ðŸ“„</text>" +
              "<text x='55' y='138' font-size='14' text-anchor='middle' dominant-baseline='middle' fill='#333' font-family='system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif'>room</text>" +
              "<line x1='90' y1='100' x2='540' y2='100' stroke='#1E66F5' stroke-width='6' stroke-linecap='round'/>" +
              "<line x1='250' y1='4' x2='250' y2='172' stroke='#1E66F5' stroke-width='6' stroke-linecap='round'/>" +
              "<line x1='220' y1='55' x2='280' y2='55' stroke='#1E66F5' stroke-width='6' stroke-linecap='round'/>" +
              "<line x1='410' y1='16' x2='410' y2='172' stroke='#1E66F5' stroke-width='6' stroke-linecap='round'/>" +
              "<text x='250' y='8' font-size='22' text-anchor='middle' dominant-baseline='middle'>ðŸ“„</text>" +
              "<text x='250' y='172' font-size='22' text-anchor='middle' dominant-baseline='middle'>ðŸ“„</text>" +
              "<text x='220' y='55' font-size='22' text-anchor='middle' dominant-baseline='middle'>ðŸ“„</text>" +
              "<text x='280' y='55' font-size='22' text-anchor='middle' dominant-baseline='middle'>ðŸ“„</text>" +
              "<text x='410' y='16' font-size='22' text-anchor='middle' dominant-baseline='middle'>ðŸ“„</text>" +
              "<text x='410' y='172' font-size='22' text-anchor='middle' dominant-baseline='middle'>ðŸ“„</text>" +
              "<text x='550' y='100' font-size='30' text-anchor='middle' dominant-baseline='middle'>ðŸ“„</text>" +
              "<circle id='hallway-cursor-dot' cx='90' cy='100' r='6' fill='#ff4fa3' style='display:none' />" +
              "</svg>" +
              "</div>",
            "<strong>cd</strong> changes your working directory, hence, c.hange d.irectory. Use <strong>cd filepath</strong> to move into a folder; <strong>cd ..</strong> goes up to the parent; <strong>cd ~</strong> jumps to your home (here, the campus root). After you change location, <strong>ls</strong> shows whatâ€™s inside the current directory.",
          ],
          [
            "Every file and directory belongs to an <strong>owner</strong>, which is a single user account responsible for it; it also belongs to a <strong>group</strong>, which is a named team of user accounts, and everyone else on the system is treated as <strong>other</strong>. In the school picture, imagine the Harvard-Westlake school as one person, the owner is that one person who owns a given room, or hallway. The group could for example be the student body, who is also given certain privleges in the room, or hallway. Finally, other(s) are the general public, who may only be granted access to the room or hallway during a public Harvard-Westlake event. The system checks three basic actions for each of these audiences: <strong>read</strong>, <strong>write</strong>, and <strong>execute</strong>. On a file, read means you may view the contents, write means you may change the contents, and execute means you may run it as a program if it is runnable. On a directory, read means you may list the names inside, write means you may add, rename, or remove entries, and execute means you may enter it and move through it when you already know the name of something inside." +
              "<div aria-label='Owner, group, and other icons' style='margin:12px 0 8px; display:flex; justify-content:center; align-items:flex-end; gap:32px; flex-wrap:wrap;'>" +
              "<div style='display:flex; flex-direction:column; align-items:center; line-height:1;'>" +
              "<div aria-hidden='true' style='font-size:44px;'>ðŸ¤´</div>" +
              "<div style='margin-top:6px; font-weight:700; font-size:14px;'>owner</div>" +
              "</div>" +
              "<div style='display:flex; flex-direction:column; align-items:center; line-height:1;'>" +
              "<div aria-hidden='true' style='display:flex; align-items:center; padding-left:14px;'>" +
              "<span style='font-size:40px; margin-left:0; filter:drop-shadow(0 1px 0 rgba(0,0,0,0.12));'>ðŸ§‘â€ðŸŽ“</span>" +
              "<span style='font-size:40px; margin-left:-14px; filter:drop-shadow(0 1px 0 rgba(0,0,0,0.12));'>ðŸ§‘â€ðŸŽ“</span>" +
              "<span style='font-size:40px; margin-left:-14px; filter:drop-shadow(0 1px 0 rgba(0,0,0,0.12));'>ðŸ§‘â€ðŸŽ“</span>" +
              "<span style='font-size:40px; margin-left:-14px; filter:drop-shadow(0 1px 0 rgba(0,0,0,0.12));'>ðŸ§‘â€ðŸŽ“</span>" +
              "<span style='font-size:40px; margin-left:-14px; filter:drop-shadow(0 1px 0 rgba(0,0,0,0.12));'>ðŸ§‘â€ðŸŽ“</span>" +
              "</div>" +
              "<div style='margin-top:6px; font-weight:700; font-size:14px;'>group</div>" +
              "</div>" +
              "<div style='display:flex; flex-direction:column; align-items:center; line-height:1;'>" +
              "<div aria-hidden='true' style='font-size:44px;'>ðŸ•µï¸</div>" +
              "<div style='margin-top:6px; font-weight:700; font-size:14px;'>other</div>" +
              "</div>" +
              "</div>" +
              "<div aria-hidden='true' style='width:100%; display:flex; justify-content:center; margin:8px 0 10px;'>" +
              "<div style='font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace; font-size:16px; opacity:0.7;'>--------------------</div>" +
              "</div>" +
              "<div aria-label='Read, write, execute icons' style='width:100%; display:flex; justify-content:center; align-items:flex-end; gap:36px; flex-wrap:wrap;'>" +
              "<div style='display:flex; flex-direction:column; align-items:center; line-height:1;'>" +
              "<div aria-hidden='true' style='font-size:40px;'>ðŸ“–</div>" +
              "<div style='margin-top:6px; font-weight:700; font-size:14px;'>read</div>" +
              "</div>" +
              "<div style='display:flex; flex-direction:column; align-items:center; line-height:1;'>" +
              "<div aria-hidden='true' style='font-size:40px;'>âœï¸</div>" +
              "<div style='margin-top:6px; font-weight:700; font-size:14px;'>write</div>" +
              "</div>" +
              "<div style='display:flex; flex-direction:column; align-items:center; line-height:1;'>" +
              "<div aria-hidden='true' style='font-size:40px;'>ðŸ”´</div>" +
              "<div style='margin-top:6px; font-weight:700; font-size:14px;'>execute</div>" +
              "</div>" +
              "</div>",
            "<strong>ls -l</strong> shows a â€œlong listingâ€ of the current directory: each item on its own line with its permissions, number of links, owner, group, size, last modified time, and name. This is like reading the hallway roster that lists each room with its posted rules and who is responsible.",
          ],
          [
            "<strong>chmod</strong> changes the rules themselvesâ€”who may read, who may write, and who may execute, without changing who owns a file or which group it belongs to. In the school picture, this is like updating the sign on a roomâ€™s door: â€œTeachers may rearrange desks,â€ â€œClub members may come in after school,â€ â€œGuests may only observe.â€ The people and clubs donâ€™t change; the posted rules for owner, group, and others do.",
            "<strong>chown</strong> changes who is officially responsible for a file or directory by transferring its owner to a different user account. In the school picture, this is like handing the keys and responsibility for a room from one teacher to another; the room may keep the same posted rules, but the person who counts as â€œthe ownerâ€ for permission checks is now different.",
            "<strong>chgrp</strong> changes which team a file or directory is associated with by switching its group. In the school picture, this is like reassigning a room from the Chess Club to the Debate Team; the â€œgroup rulesâ€ on the door still say what that group may do, but they now apply to the new club rather than the old one.",
          ],
          [
            "Sometimes you need elevated privileges to perform actions on files or directories you do not own. The <strong>sudo</strong> command temporarily runs a command with administrator (root) privileges. For example, if you try to change permissions on a directory owned by someone else, a normal <strong>chmod</strong> will fail with â€œOperation not permitted.â€ Prefixing the same command with <strong>sudo</strong> allows itâ€”after authenticatingâ€”to proceed so you can, for example, grant <strong>read</strong> and <strong>execute</strong> access where appropriate.",
          ],
        ];

        // ===== Unified Flow State =====
        var sectionIndex = 0;
        var paragraphIndex = -1; // start so first Enter shows the first sentence
        var mode = "text"; // text | demo-cd | demo-ls | demo-ch | end

        // Welcome lines (auto shown)
        appendInstructionHtml(
          "<strong>Welcome!</strong> This terminal will teach you <strong>file permissions</strong> step by step."
        );
        appendInstructionHtml("Press Enter to continue through the lesson.");

        // ===== Demo 1: cd practice =====
        var cd = (function () {
          var path = ["Harvard-Westlake"];
          function getNode(arr) {
            return fsNodeByPath(arr);
          }
          function listCurrent() {
            var node = getNode(path);
            return Object.keys((node && node.children) || {}).sort();
          }
          function promptPath() {
            return "~/" + path.join("/");
          }
          var step = 0;
          var free = false;

          function start() {
            mode = "demo-cd";
            activeDemoKey = "demo-cd";
            saveFsBaseline(activeDemoKey);
            appendInstructionHtml(
              '<span class="title-line"><strong>cd practice</strong></span>'
            );
            appendInstructionHtml("Follow the prompts to practice cd and ls.");
            updatePrompt("hwwolverine@DESKTOP-WSL", promptPath());
            showNext();
            suggestHint(
              "hint-cd-path",
              "Tip: Click the <strong>Filesystem</strong> tab to see the current directory highlighted on the campus map."
            );
          }
          function showNext() {
            var lines = [
              "Try: cd ChalmersHall",
              "Try: ls",
              "Try: cd SecondFloor",
              "Try: ls",
              "Try: cd ..",
              "Try: ls",
              "Try: cd ~",
              "Try: ls",
              "Try: cd SeaverAcademicCenter",
              "Try: ls",
            ];
            if (step < lines.length) {
              appendInstructionHtml(lines[step]);
            } else {
              appendInstructionHtml(
                "Free practice: use cd and ls to navigate the school tree and see what is inside each directory. Bonus challenge: try drawing out the file system tree on a piece of paper. Type <strong>q</strong> to exit."
              );
              free = true;
            }
          }
          function onEnter(cmd) {
            if (!free) {
              // Developer bypass: 's' runs the expected next instruction
              if (cmd === "s") {
                if (step === 0) cmd = "cd ChalmersHall";
                else if (step === 1) cmd = "ls";
                else if (step === 2) cmd = "cd SecondFloor";
                else if (step === 3) cmd = "ls";
                else if (step === 4) cmd = "cd ..";
                else if (step === 5) cmd = "ls";
                else if (step === 6) cmd = "cd ~";
                else if (step === 7) cmd = "ls";
                else if (step === 8) cmd = "cd SeaverAcademicCenter";
                else if (step === 9) cmd = "ls";
              }
              if (step === 0) {
                if (cmd === "cd ChalmersHall") {
                  path.push("ChalmersHall");
                  updatePrompt("hwwolverine@DESKTOP-WSL", promptPath());
                  step = 1;
                  appendInstructionHtml(
                    'Notice how the command line updated to show the new path of the working directory. Now type "ls" to see what is inside this folder.'
                  );
                } else appendInstructionHtml("Try: cd ChalmersHall");
              } else if (step === 1) {
                if (cmd === "ls") {
                  listCurrent().forEach(function (n) {
                    appendRawLine(
                      '<span class="ls-dir">' + escapeHtml(n) + "</span>"
                    );
                  });
                  fsShowLsPreview(fsCurrentPath);
                  step = 2;
                  showNext();
                } else appendInstructionHtml("Try: ls");
              } else if (step === 2) {
                if (cmd === "cd SecondFloor") {
                  path.push("SecondFloor");
                  updatePrompt("hwwolverine@DESKTOP-WSL", promptPath());
                  step = 3;
                  appendInstructionHtml(
                    'Now type "ls" to see what is inside this folder.'
                  );
                } else appendInstructionHtml("Try: cd SecondFloor");
              } else if (step === 3) {
                if (cmd === "ls") {
                  listCurrent().forEach(function (n) {
                    appendRawLine(
                      '<span class="ls-dir">' + escapeHtml(n) + "</span>"
                    );
                  });
                  fsShowLsPreview(fsCurrentPath);
                  step = 4;
                  showNext();
                } else appendInstructionHtml("Try: ls");
              } else if (step === 4) {
                if (cmd === "cd ..") {
                  if (path.length > 1) path.pop();
                  updatePrompt("hwwolverine@DESKTOP-WSL", promptPath());
                  step = 5;
                  appendInstructionHtml(
                    'Now type "ls" to see what is inside this folder.'
                  );
                } else appendInstructionHtml("Try: cd ..");
              } else if (step === 5) {
                if (cmd === "ls") {
                  listCurrent().forEach(function (n) {
                    appendRawLine(
                      '<span class="ls-dir">' + escapeHtml(n) + "</span>"
                    );
                  });
                  fsShowLsPreview(fsCurrentPath);
                  step = 6;
                  showNext();
                } else appendInstructionHtml("Try: ls");
              } else if (step === 6) {
                if (cmd === "cd ~") {
                  path = ["Harvard-Westlake"];
                  updatePrompt("hwwolverine@DESKTOP-WSL", promptPath());
                  step = 7;
                  appendInstructionHtml(
                    'Now type "ls" to see what is inside this folder.'
                  );
                } else appendInstructionHtml("Try: cd ~");
              } else if (step === 7) {
                if (cmd === "ls") {
                  listCurrent().forEach(function (n) {
                    appendRawLine(
                      '<span class="ls-dir">' + escapeHtml(n) + "</span>"
                    );
                  });
                  fsShowLsPreview(fsCurrentPath);
                  step = 8;
                  showNext();
                } else appendInstructionHtml("Try: ls");
              } else if (step === 8) {
                if (cmd === "cd SeaverAcademicCenter") {
                  path = ["Harvard-Westlake", "SeaverAcademicCenter"];
                  updatePrompt("hwwolverine@DESKTOP-WSL", promptPath());
                  step = 9;
                  appendInstructionHtml(
                    'Now type "ls" to see what is inside this folder.'
                  );
                } else appendInstructionHtml("Try: cd SeaverAcademicCenter");
              } else if (step === 9) {
                if (cmd === "ls") {
                  listCurrent().forEach(function (n) {
                    appendRawLine(
                      '<span class="ls-dir">' + escapeHtml(n) + "</span>"
                    );
                  });
                  fsShowLsPreview(fsCurrentPath);
                  step = 10;
                  showNext();
                } else appendInstructionHtml("Try: ls");
              }
            } else {
              if (cmd === "q") {
                appendInstructionHtml("Exiting demo...");
                nextSection();
                return;
              }
              if (cmd === "ls") {
                listCurrent().forEach(function (n) {
                  appendRawLine(
                    '<span class="ls-dir">' + escapeHtml(n) + "</span>"
                  );
                });
                fsShowLsPreview(fsCurrentPath);
              } else if (cmd === "cd ..") {
                if (path.length > 1) path.pop();
                updatePrompt("hwwolverine@DESKTOP-WSL", promptPath());
              } else if (cmd === "cd ~") {
                path = ["Harvard-Westlake"];
                updatePrompt("hwwolverine@DESKTOP-WSL", promptPath());
              } else if (cmd.indexOf("cd ") === 0) {
                var tgt = cmd.slice(3).trim();
                if (listCurrent().indexOf(tgt) !== -1) {
                  path.push(tgt);
                  updatePrompt("hwwolverine@DESKTOP-WSL", promptPath());
                }
              }
            }
          }
          return { start: start, onEnter: onEnter };
        })();

        // ===== Demo 2: ls -l practice =====
        var lsDemo = (function () {
          var path = ["Harvard-Westlake", "ChalmersHall", "SecondFloor"];
          function getNode(arr) {
            return fsNodeByPath(arr);
          }
          function updatePromptPath() {
            var p = "~/" + path.join("/");
            updatePrompt("hwwolverine@DESKTOP-WSL", p);
          }
          function lsLong() {
            var node = getNode(path);
            var entries = [];
            if (node && node.children) {
              var names = Object.keys(node.children).sort();
              for (var i = 0; i < names.length; i++) {
                var child = node.children[names[i]];
                entries.push({
                  type: child.type || "file",
                  mode:
                    child.mode ||
                    (child.type === "dir" ? "drwxr-xr-x" : "-rw-r--r--"),
                  nlink: child.nlink || 1,
                  owner: child.owner || "hw_admin",
                  group: child.group || "faculty",
                  size: child.size || 4096,
                  mtime: child.mtime || "Nov 16 12:00",
                  name: child.name || names[i],
                });
              }
            }
            var total = entries.length * 4;
            appendLine("total " + total);
            for (var i = 0; i < entries.length; i++) {
              var e = entries[i];
              var nameHtml =
                e.type === "dir"
                  ? '<span class="ls-dir">' + escapeHtml(e.name) + "</span>"
                  : escapeHtml(e.name);
              appendRawLine(
                escapeHtml(
                  e.mode +
                    " " +
                    e.nlink +
                    " " +
                    e.owner +
                    " " +
                    e.group +
                    " " +
                    ("" + e.size).padStart(4, " ") +
                    " " +
                    e.mtime +
                    " "
                ) + nameHtml
              );
            }
            // Same preview as `ls`, but with `ls -l` metadata inside the red directory box.
            fsShowLsPreview(fsCurrentPath, { long: true });
          }
          var step = 0;
          var free = false;
          function start() {
            mode = "demo-ls";
            activeDemoKey = "demo-ls";
            saveFsBaseline(activeDemoKey);
            appendInstructionHtml(
              '<span class="title-line"><strong>ls -l practice</strong></span>'
            );
            appendInstructionHtml(
              "Follow the prompts. When free practice begins, type <strong>q</strong> and press Enter to continue the lesson."
            );
            updatePromptPath();
            showNext();
          }
          function showNext() {
            switch (step) {
              case 0:
                appendInstructionHtml("Try: ls -l");
                break;
              case 1:
                appendInstructionHtml("Try: cd StudentLounge");
                break;
              case 2:
                appendInstructionHtml("Try: ls -l");
                break;
              case 3:
                appendInstructionHtml("Try: cd ..");
                break;
              case 4:
                appendInstructionHtml("Try: cd Cafeteria");
                break;
              case 5:
                appendInstructionHtml("Try: ls -l");
                break;
              default:
                appendInstructionHtml(
                  "All set! Free practice: use cd and ls -l. Type <strong>q</strong> to exit."
                );
                free = true;
            }
          }
          function onEnter(cmd) {
            if (!free) {
              // Developer bypass: 's' runs the expected next instruction
              if (cmd === "s") {
                if (step === 0) cmd = "ls -l";
                else if (step === 1) cmd = "cd StudentLounge";
                else if (step === 2) cmd = "ls -l";
                else if (step === 3) cmd = "cd ..";
                else if (step === 4) cmd = "cd Cafeteria";
                else if (step === 5) cmd = "ls -l";
              }
              if (step === 0) {
                if (cmd === "ls -l") {
                  lsLong();
                  step = 1;
                  showNext();
                  suggestHint(
                    "hint-ls-long",
                    "Tip: Open the <strong>Filesystem</strong> tab to browse buildings and rooms while you read the long listing."
                  );
                } else appendInstructionHtml("Try: ls -l");
              } else if (step === 1) {
                if (cmd === "cd StudentLounge") {
                  path.push("StudentLounge");
                  updatePromptPath();
                  step = 2;
                  showNext();
                } else appendInstructionHtml("Try: cd StudentLounge");
              } else if (step === 2) {
                if (cmd === "ls -l") {
                  lsLong();
                  step = 3;
                  showNext();
                } else appendInstructionHtml("Try: ls -l");
              } else if (step === 3) {
                if (cmd === "cd ..") {
                  if (path.length > 1) path.pop();
                  updatePromptPath();
                  step = 4;
                  showNext();
                } else appendInstructionHtml("Try: cd ..");
              } else if (step === 4) {
                if (cmd === "cd Cafeteria") {
                  path.push("Cafeteria");
                  updatePromptPath();
                  step = 5;
                  showNext();
                } else appendInstructionHtml("Try: cd Cafeteria");
              } else if (step === 5) {
                if (cmd === "ls -l") {
                  lsLong();
                  step = 6;
                  showNext();
                } else appendInstructionHtml("Try: ls -l");
              }
            } else {
              if (cmd === "q") {
                appendInstructionHtml("Exiting demo...");
                nextSection();
                return;
              }
              if (cmd === "ls -l") {
                lsLong();
              } else if (cmd === "cd ..") {
                if (path.length > 1) path.pop();
                updatePromptPath();
              } else if (cmd === "cd ~") {
                path = ["Harvard-Westlake"];
                updatePromptPath();
              } else if (/^cd\s+(\S+)$/.test(cmd)) {
                var m = /^cd\s+(\S+)$/.exec(cmd);
                var target = (m && m[1]) || "";
                var node = getNode(path);
                var names = Object.keys((node && node.children) || {});
                if (names.indexOf(target) !== -1) {
                  path.push(target);
                  updatePromptPath();
                }
              }
            }
          }
          return { start: start, onEnter: onEnter };
        })();

        // ===== Demo 3: chmod/chown/chgrp practice =====
        var chDemo = (function () {
          var file = {
            mode: "-rw-r--r--",
            nlink: 1,
            owner: "hw_admin",
            group: "students",
            size: 1024,
            mtime: "Nov 17 09:00",
            name: "demo.sh",
          };
          var nav = {
            name: "Harvard-Westlake",
            children: {
              ChalmersHall: { children: { SecondFloor: { children: {} } } },
              SeaverAcademicCenter: { children: {} },
            },
          };
          var navPath = ["Harvard-Westlake", "ChalmersHall"];
          function listDirNames() {
            var node = nav;
            for (var i = 1; i < navPath.length; i++) {
              var name = navPath[i];
              if (!node.children || !node.children[name]) return [];
              node = node.children[name];
            }
            return Object.keys(node.children || {}).sort();
          }
          function updatePromptPath() {
            updatePrompt("hwwolverine@DESKTOP-WSL", "~/" + navPath.join("/"));
          }
          function lsLong() {
            appendLine("total 4");
            appendRawLine(
              escapeHtml(
                file.mode +
                  " " +
                  file.nlink +
                  " " +
                  file.owner +
                  " " +
                  file.group +
                  " " +
                  ("" + file.size).padStart(4, " ") +
                  " " +
                  file.mtime +
                  " " +
                  file.name
              )
            );
            // Same preview as `ls`, but with `ls -l` metadata inside the red directory box.
            fsShowLsPreview(fsCurrentPath, { long: true });
          }
          function applyChmod(spec) {
            var m = /^([ugoa]+)([+\-=])([rwx]+)$/.exec(spec);
            if (!m) return false;
            var who = m[1];
            var op = m[2];
            var perms = m[3];
            var current = file.mode.slice(1);
            var parts = [
              current.slice(0, 3).split(""),
              current.slice(3, 6).split(""),
              current.slice(6, 9).split(""),
            ];
            function idxs(w) {
              var set = [];
              if (w.indexOf("a") !== -1) return [0, 1, 2];
              if (w.indexOf("u") !== -1) set.push(0);
              if (w.indexOf("g") !== -1) set.push(1);
              if (w.indexOf("o") !== -1) set.push(2);
              return set.length ? set : [0];
            }
            function bits(p) {
              return {
                r: p.indexOf("r") !== -1,
                w: p.indexOf("w") !== -1,
                x: p.indexOf("x") !== -1,
              };
            }
            var b = bits(perms);
            var targets = idxs(who);
            for (var t = 0; t < targets.length; t++) {
              var tri = parts[targets[t]];
              if (op === "+") {
                if (b.r) tri[0] = "r";
                if (b.w) tri[1] = "w";
                if (b.x) tri[2] = "x";
              } else if (op === "-") {
                if (b.r) tri[0] = "-";
                if (b.w) tri[1] = "-";
                if (b.x) tri[2] = "-";
              } else if (op === "=") {
                tri[0] = b.r ? "r" : "-";
                tri[1] = b.w ? "w" : "-";
                tri[2] = b.x ? "x" : "-";
              }
            }
            file.mode =
              "-" + parts[0].join("") + parts[1].join("") + parts[2].join("");
            return true;
          }
          var step = 0;
          var free = false;
          function start() {
            mode = "demo-ch";
            activeDemoKey = "demo-ch";
            saveFsBaseline(activeDemoKey);
            appendInstructionHtml(
              '<span class="title-line"><strong>chmod, chown, chgrp practice</strong></span>'
            );
            appendInstructionHtml(
              "Follow the prompts. When free practice begins, type <strong>q</strong> and press Enter to continue the lesson."
            );
            updatePromptPath();
            showNext();
          }
          function showNext() {
            switch (step) {
              case 0:
                appendInstructionHtml("Try: ls -l");
                break;
              case 1:
                appendInstructionHtml("Try: chmod u+x demo.sh");
                break;
              case 2:
                appendInstructionHtml("Try: chown teacher_lee demo.sh");
                break;
              case 3:
                appendInstructionHtml("Try: chgrp faculty demo.sh");
                break;
              default:
                appendInstructionHtml(
                  "All set! Free practice. Type <strong>q</strong> to exit."
                );
                free = true;
            }
          }
          function onEnter(cmd) {
            if (!free) {
              // Developer bypass: 's' runs the expected next instruction
              if (cmd === "s") {
                if (step === 0) cmd = "ls -l";
                else if (step === 1) cmd = "chmod u+x demo.sh";
                else if (step === 2) cmd = "chown teacher_lee demo.sh";
                else if (step === 3) cmd = "chgrp faculty demo.sh";
              }
              if (step === 0) {
                if (cmd === "ls -l") {
                  lsLong();
                  step = 1;
                  showNext();
                } else appendInstructionHtml("Try: ls -l");
              } else if (step === 1) {
                if (cmd === "chmod u+x demo.sh") {
                  applyChmod("u+x");
                  lsLong();
                  if (typeof fsUpdateDemoFile === "function") {
                    fsUpdateDemoFile(file.mode, file.owner, file.group);
                  }
                  suggestHint(
                    "hint-chmod",
                    "Notice the <strong>permissions</strong> changed. Peek at the <strong>Filesystem</strong> tab to see the rwx grid update."
                  );
                  step = 2;
                  showNext();
                } else appendInstructionHtml("Try: chmod u+x demo.sh");
              } else if (step === 2) {
                var m1 = /^chown\s+(\S+)\s+(\S+)$/.exec(cmd);
                if (m1 && m1[1] === "teacher_lee" && m1[2] === file.name) {
                  file.owner = "teacher_lee";
                  lsLong();
                  if (typeof fsUpdateDemoFile === "function") {
                    fsUpdateDemoFile(file.mode, file.owner, file.group);
                  }
                  step = 3;
                  showNext();
                } else appendInstructionHtml("Try: chown teacher_lee demo.sh");
              } else if (step === 3) {
                var m2 = /^chgrp\s+(\S+)\s+(\S+)$/.exec(cmd);
                if (m2 && m2[1] === "faculty" && m2[2] === file.name) {
                  file.group = "faculty";
                  lsLong();
                  if (typeof fsUpdateDemoFile === "function") {
                    fsUpdateDemoFile(file.mode, file.owner, file.group);
                  }
                  step = 4;
                  showNext();
                } else appendInstructionHtml("Try: chgrp faculty demo.sh");
              }
            } else {
              if (cmd === "q") {
                appendInstructionHtml("Exiting demo...");
                nextSection();
                return;
              }
              if (cmd === "ls -l") {
                lsLong();
              } else if (/^chmod\s+([ugoa][+\-=][rwx]+)\s+(\S+)$/.test(cmd)) {
                var cm = /^chmod\s+([ugoa][+\-=][rwx]+)\s+(\S+)$/.exec(cmd);
                if (cm && cm[2] === file.name) {
                  if (applyChmod(cm[1])) {
                    lsLong();
                    if (typeof fsUpdateDemoFile === "function") {
                      fsUpdateDemoFile(file.mode, file.owner, file.group);
                    }
                  }
                }
              } else if (/^chown\s+(\S+)\s+(\S+)$/.test(cmd)) {
                var c1 = /^chown\s+(\S+)\s+(\S+)$/.exec(cmd);
                if (c1 && c1[2] === file.name) {
                  file.owner = c1[1];
                  lsLong();
                  if (typeof fsUpdateDemoFile === "function") {
                    fsUpdateDemoFile(file.mode, file.owner, file.group);
                  }
                }
              } else if (/^chgrp\s+(\S+)\s+(\S+)$/.test(cmd)) {
                var c2 = /^chgrp\s+(\S+)\s+(\S+)$/.exec(cmd);
                if (c2 && c2[2] === file.name) {
                  file.group = c2[1];
                  lsLong();
                  if (typeof fsUpdateDemoFile === "function") {
                    fsUpdateDemoFile(file.mode, file.owner, file.group);
                  }
                }
              }
            }
          }
          return { start: start, onEnter: onEnter };
        })();

        // ===== Demo 4: sudo scenario =====
        var sudoDemo = (function () {
          var sudoPassword = "r7Qx9Za"; // 7-char random-looking string
          var nav = {
            name: "Harvard-Westlake",
            children: {
              ChalmersHall: { children: { RestrictedArea: { children: {} } } },
              SeaverAcademicCenter: { children: {} },
            },
          };
          var navPath = ["Harvard-Westlake", "ChalmersHall"];
          var restrictedPerm = { otherRead: false, otherExec: false };
          var awaitingPassword = false;

          function updatePromptPath() {
            updatePrompt("hwwolverine@DESKTOP-WSL", "~/" + navPath.join("/"));
          }
          function canCdRestricted() {
            return restrictedPerm.otherExec;
          }
          function sudoUserName() {
            var at = (currentUserhost || "").indexOf("@");
            return at !== -1
              ? currentUserhost.slice(0, at)
              : currentUserhost || "user";
          }

          var step = 0;
          var free = false;

          function start() {
            mode = "demo-sudo";
            activeDemoKey = "demo-sudo";
            saveFsBaseline(activeDemoKey);
            appendInstructionHtml(
              '<span class="title-line"><strong>sudo practice</strong></span>'
            );
            appendInstructionHtml(
              "Follow the prompts. When free practice begins, type <strong>q</strong> and press Enter to finish."
            );
            updatePromptPath();
            showNext();
          }
          function showNext() {
            switch (step) {
              case 0:
                appendInstructionHtml("Try: cd RestrictedArea");
                break;
              case 1:
                appendInstructionHtml("Try: chmod o+r RestrictedArea");
                break;
              case 2:
                appendInstructionHtml(
                  "Try: sudo chmod o+rx RestrictedArea (password: " +
                    sudoPassword +
                    ")"
                );
                break;
              case 3:
                appendInstructionHtml("Try: cd RestrictedArea");
                break;
              default:
                appendInstructionHtml(
                  "All set! Free practice. Type <strong>q</strong> to exit."
                );
                free = true;
            }
          }
          function onEnter(cmd) {
            if (!free) {
              // Developer bypass
              if (cmd === "s") {
                if (step === 0) cmd = "cd RestrictedArea";
                else if (step === 1) cmd = "chmod o+r RestrictedArea";
                else if (step === 2) cmd = "sudo chmod o+rx RestrictedArea";
                else if (step === 3) cmd = "cd RestrictedArea";
              }
              // Handle password input if awaiting
              if (awaitingPassword) {
                if (cmd === sudoPassword) {
                  restrictedPerm.otherRead = true;
                  restrictedPerm.otherExec = true;
                  awaitingPassword = false;
                  hideInput = false;
                  if (typeof fsUpdateRestrictedAreaPerms === "function") {
                    fsUpdateRestrictedAreaPerms(
                      restrictedPerm.otherRead,
                      restrictedPerm.otherExec
                    );
                  }
                  suggestHint(
                    "hint-sudo",
                    "Access granted. Check the <strong>Filesystem</strong> tab to see how <strong>RestrictedArea</strong> changed."
                  );
                  step = 3;
                  showNext();
                } else {
                  appendLine("Sorry, try again.");
                  appendLine("[sudo] password for " + sudoUserName() + ":");
                  hideInput = true;
                }
                return;
              }
              if (step === 0) {
                if (cmd === "cd RestrictedArea") {
                  if (!canCdRestricted()) {
                    appendLine("bash: cd: RestrictedArea: Permission denied");
                    appendInstructionHtml(
                      "You need execute permission to enter a directory; others donâ€™t have it here."
                    );
                    step = 1;
                    showNext();
                  } else {
                    navPath.push("RestrictedArea");
                    updatePromptPath();
                    step = 4;
                    showNext();
                  }
                } else appendInstructionHtml("Try: cd RestrictedArea");
              } else if (step === 1) {
                if (cmd === "chmod o+r RestrictedArea") {
                  appendLine(
                    "chmod: changing permissions of 'RestrictedArea': Operation not permitted"
                  );
                  appendInstructionHtml(
                    "You donâ€™t own this directory. Use administrator privileges to change its permissions."
                  );
                  step = 2;
                  showNext();
                } else appendInstructionHtml("Try: chmod o+r RestrictedArea");
              } else if (step === 2) {
                if (cmd === "sudo chmod o+rx RestrictedArea") {
                  appendLine("[sudo] password for " + sudoUserName() + ":");
                  awaitingPassword = true;
                  hideInput = true;
                } else
                  appendInstructionHtml(
                    "Try: sudo chmod o+rx RestrictedArea (password: " +
                      sudoPassword +
                      ")"
                  );
              } else if (step === 3) {
                if (cmd === "cd RestrictedArea") {
                  if (canCdRestricted()) {
                    navPath.push("RestrictedArea");
                    updatePromptPath();
                    appendInstructionHtml(
                      "<strong>Great job!</strong> You elevated privileges appropriately and accessed the directory."
                    );
                    endLesson();
                  } else {
                    appendLine("bash: cd: RestrictedArea: Permission denied");
                  }
                } else appendInstructionHtml("Try: cd RestrictedArea");
              }
            } else {
              if (cmd === "q") {
                appendInstructionHtml("Exiting demo...");
                endLesson();
                return;
              }
            }
          }
          return { start: start, onEnter: onEnter };
        })();

        function nextSection() {
          if (mode === "demo-cd") {
            restoreFsBaseline(activeDemoKey);
            activeDemoKey = null;
            // After cd demo, show section 2 (ownership/rwx + ls -l text), then ls demo
            sectionIndex = 1;
            paragraphIndex = -1;
            mode = "text";
            appendInstructionHtml("Press Enter to continue the lesson.");
          } else if (mode === "demo-ls") {
            restoreFsBaseline(activeDemoKey);
            activeDemoKey = null;
            // After ls demo, show section 3 (chmod/chown/chgrp), then ch demo
            sectionIndex = 2;
            paragraphIndex = -1;
            mode = "text";
            appendInstructionHtml("Press Enter to continue the lesson.");
          } else if (mode === "demo-ch") {
            // After ch demo, show sudo explanation then sudo demo
            restoreFsBaseline(activeDemoKey);
            activeDemoKey = null;
            sectionIndex = 3;
            paragraphIndex = -1;
            mode = "text";
            appendInstructionHtml("Press Enter to continue the lesson.");
          }
        }

        function endLesson() {
          // Ensure we restore any demo-related mutations before ending
          restoreFsBaseline(activeDemoKey);
          activeDemoKey = null;
          mode = "end";
          appendInstructionHtml(
            "The lesson is complete. You can keep practicing here or refresh to restart."
          );
        }

        function startNextDemoForSection(idx) {
          if (idx === 0) {
            cd.start();
          } else if (idx === 1) {
            lsDemo.start();
          } else if (idx === 2) {
            chDemo.start();
          } else if (idx === 3) {
            sudoDemo.start();
          }
        }

        // ===== Cursor dot (for the hallway graphic) =====
        var hallwayCursorDotCleanup = null;
        function stopHallwayCursorDot() {
          if (typeof hallwayCursorDotCleanup === "function") {
            hallwayCursorDotCleanup();
          }
          hallwayCursorDotCleanup = null;
        }
        function startHallwayCursorDot() {
          stopHallwayCursorDot();
          var svg = document.getElementById("hallway-cursor-svg");
          var dot = document.getElementById("hallway-cursor-dot");
          if (!svg || !dot) return;

          dot.style.display = "block";

          // Line segments in SVG coordinates.
          // The dot must *travel along the connected graph* (no hopping between segments).
          var segments = [
            // main hallway
            { x1: 90, y1: 100, x2: 540, y2: 100 },
            // left vertical
            { x1: 250, y1: 4, x2: 250, y2: 172 },
            // mid tick (connected to left vertical)
            { x1: 220, y1: 55, x2: 280, y2: 55 },
            // right vertical (connected to main hallway)
            { x1: 410, y1: 16, x2: 410, y2: 172 },
          ];

          function closestPointOnSegment(px, py, x1, y1, x2, y2) {
            var dx = x2 - x1;
            var dy = y2 - y1;
            var len2 = dx * dx + dy * dy;
            if (len2 === 0) return { x: x1, y: y1 };
            var t = ((px - x1) * dx + (py - y1) * dy) / len2;
            if (t < 0) t = 0;
            if (t > 1) t = 1;
            return { x: x1 + t * dx, y: y1 + t * dy };
          }

          function pickNearestOnNetwork(px, py) {
            var best = { x: 90, y: 100 };
            var bestSeg = 0;
            var bestD2 = Infinity;
            for (var i = 0; i < segments.length; i++) {
              var s = segments[i];
              var p = closestPointOnSegment(px, py, s.x1, s.y1, s.x2, s.y2);
              var ddx = px - p.x;
              var ddy = py - p.y;
              var d2 = ddx * ddx + ddy * ddy;
              if (d2 < bestD2) {
                bestD2 = d2;
                best = p;
                bestSeg = i;
              }
            }
            return { point: best, segIndex: bestSeg };
          }

          function keyForPoint(p) {
            // keep it stable for dictionary keys
            return Math.round(p.x * 1000) / 1000 + "," + Math.round(p.y * 1000) / 1000;
          }

          function dist(a, b) {
            var dx = a.x - b.x;
            var dy = a.y - b.y;
            return Math.sqrt(dx * dx + dy * dy);
          }

          function buildGraph(extraPoints) {
            // Base nodes (endpoints + intersections)
            var nodes = [];
            function addNode(p) {
              var k = keyForPoint(p);
              for (var i = 0; i < nodes.length; i++) {
                if (keyForPoint(nodes[i]) === k) return;
              }
              nodes.push({ x: p.x, y: p.y });
            }

            // segment endpoints
            for (var i = 0; i < segments.length; i++) {
              addNode({ x: segments[i].x1, y: segments[i].y1 });
              addNode({ x: segments[i].x2, y: segments[i].y2 });
            }

            // intersections for this known network
            addNode({ x: 250, y: 100 }); // left vertical with main hallway
            addNode({ x: 410, y: 100 }); // right vertical with main hallway
            addNode({ x: 250, y: 55 }); // mid tick with left vertical

            // extra points (current and target), already on some segment
            for (var j = 0; j < extraPoints.length; j++) addNode(extraPoints[j]);

            var adj = {};
            function ensureAdj(k) {
              if (!adj[k]) adj[k] = [];
            }
            function connect(a, b) {
              var ka = keyForPoint(a);
              var kb = keyForPoint(b);
              ensureAdj(ka);
              ensureAdj(kb);
              var w = dist(a, b);
              adj[ka].push({ to: kb, w: w });
              adj[kb].push({ to: ka, w: w });
            }

            function isOnSegment(p, s) {
              // axis-aligned only in this diagram
              if (s.y1 === s.y2) {
                if (Math.abs(p.y - s.y1) > 0.5) return false;
                var minX = Math.min(s.x1, s.x2);
                var maxX = Math.max(s.x1, s.x2);
                return p.x >= minX - 0.5 && p.x <= maxX + 0.5;
              }
              if (s.x1 === s.x2) {
                if (Math.abs(p.x - s.x1) > 0.5) return false;
                var minY = Math.min(s.y1, s.y2);
                var maxY = Math.max(s.y1, s.y2);
                return p.y >= minY - 0.5 && p.y <= maxY + 0.5;
              }
              return false;
            }

            function sortAlongSegment(points, s) {
              var pts = points.slice();
              if (s.y1 === s.y2) {
                pts.sort(function (a, b) {
                  return a.x - b.x;
                });
              } else {
                pts.sort(function (a, b) {
                  return a.y - b.y;
                });
              }
              return pts;
            }

            // For each segment, connect all points that lie on it in order.
            for (var si = 0; si < segments.length; si++) {
              var seg = segments[si];
              var ptsOn = [];
              for (var ni = 0; ni < nodes.length; ni++) {
                if (isOnSegment(nodes[ni], seg)) ptsOn.push(nodes[ni]);
              }
              ptsOn = sortAlongSegment(ptsOn, seg);
              for (var pi = 0; pi < ptsOn.length - 1; pi++) {
                connect(ptsOn[pi], ptsOn[pi + 1]);
              }
            }

            return { nodes: nodes, adj: adj };
          }

          function dijkstra(adj, startKey, goalKey) {
            var distMap = {};
            var prev = {};
            var visited = {};
            var keys = Object.keys(adj);
            for (var i = 0; i < keys.length; i++) distMap[keys[i]] = Infinity;
            distMap[startKey] = 0;

            while (true) {
              var u = null;
              var best = Infinity;
              for (var k in distMap) {
                if (!visited[k] && distMap[k] < best) {
                  best = distMap[k];
                  u = k;
                }
              }
              if (u === null) break;
              if (u === goalKey) break;
              visited[u] = true;
              var edges = adj[u] || [];
              for (var e = 0; e < edges.length; e++) {
                var v = edges[e].to;
                var alt = distMap[u] + edges[e].w;
                if (alt < distMap[v]) {
                  distMap[v] = alt;
                  prev[v] = u;
                }
              }
            }

            // reconstruct
            var path = [];
            var cur = goalKey;
            if (cur !== startKey && typeof prev[cur] === "undefined") return null;
            while (cur) {
              path.push(cur);
              if (cur === startKey) break;
              cur = prev[cur];
            }
            path.reverse();
            return path;
          }

          var vb = svg.viewBox && svg.viewBox.baseVal;
          var current = {
            x: parseFloat(dot.getAttribute("cx")) || 90,
            y: parseFloat(dot.getAttribute("cy")) || 100,
          };
          var plannedPathPoints = [current];
          var pathIdx = 0;
          // Faster travel so it feels responsive, but still constrained to the path.
          var speedPxPerSec = 520;
          var raf = 0;
          var lastTs = 0;

          function step(ts) {
            if (!lastTs) lastTs = ts;
            var dt = (ts - lastTs) / 1000;
            lastTs = ts;

            var remaining = speedPxPerSec * dt;
            while (remaining > 0 && plannedPathPoints.length > 1) {
              var a = plannedPathPoints[pathIdx];
              var b = plannedPathPoints[pathIdx + 1];
              if (!b) break;
              var segLen = dist(a, b);
              if (segLen < 0.001) {
                pathIdx++;
                if (pathIdx >= plannedPathPoints.length - 1) break;
                continue;
              }
              // current position is always at `current` which lies between a and b;
              // advance towards b
              var toB = dist(current, b);
              if (remaining >= toB) {
                current = { x: b.x, y: b.y };
                pathIdx++;
                remaining -= toB;
                if (pathIdx >= plannedPathPoints.length - 1) break;
              } else {
                var t = remaining / toB;
                current = {
                  x: current.x + (b.x - current.x) * t,
                  y: current.y + (b.y - current.y) * t,
                };
                remaining = 0;
              }
            }

            dot.setAttribute("cx", String(current.x));
            dot.setAttribute("cy", String(current.y));
            raf = requestAnimationFrame(step);
          }

          function onMove(e) {
            var rect = svg.getBoundingClientRect();
            if (!rect.width || !rect.height) return;
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            var sx = x, sy = y;
            if (vb && vb.width && vb.height) {
              sx = vb.x + (x / rect.width) * vb.width;
              sy = vb.y + (y / rect.height) * vb.height;
            }

            // compute a *destination point on the network* closest to the cursor,
            // then plan a route along the network from the dot's current position
            var curPick = pickNearestOnNetwork(current.x, current.y);
            var dstPick = pickNearestOnNetwork(sx, sy);
            var curP = curPick.point;
            var dstP = dstPick.point;

            var graph = buildGraph([curP, dstP]);
            var startKey = keyForPoint(curP);
            var goalKey = keyForPoint(dstP);
            var pathKeys = dijkstra(graph.adj, startKey, goalKey);
            if (!pathKeys) return;

            // Convert keys back into points
            var pointsByKey = {};
            for (var i = 0; i < graph.nodes.length; i++) {
              pointsByKey[keyForPoint(graph.nodes[i])] = graph.nodes[i];
            }
            var newPts = [];
            for (var pi = 0; pi < pathKeys.length; pi++) {
              var p = pointsByKey[pathKeys[pi]];
              if (p) newPts.push({ x: p.x, y: p.y });
            }
            if (!newPts.length) return;

            // Start from the *actual current* dot position to avoid any visible snapping.
            newPts[0] = { x: current.x, y: current.y };
            plannedPathPoints = newPts;
            pathIdx = 0;
          }

          // Track the cursor even if it leaves the SVG; dot â€œtriesâ€ to keep up.
          document.addEventListener("mousemove", onMove, { passive: true });
          raf = requestAnimationFrame(step);

          hallwayCursorDotCleanup = function () {
            document.removeEventListener("mousemove", onMove);
            if (raf) cancelAnimationFrame(raf);
            dot.style.display = "none";
          };
        }

        // Handle input
        function onKeyDown(e) {
          if (e.key !== "Enter") return;
          e.preventDefault();
          var raw = (input.textContent || "").replace(/\r?\n/g, "");
          var cmd = raw.trim();

          // Any new Enter clears the previous `ls` preview (the preview is only for the last `ls`).
          fsClearLsPreview();

          // finalize the current input line to look like a real terminal
          finalizeCurrentInput(raw);

          if (mode === "text") {
            paragraphIndex++;
            var group = textSections[sectionIndex] || [];
            if (paragraphIndex < 0) {
              // advancing through preface lines; no output
            } else if (paragraphIndex < group.length) {
              appendInstructionHtml(group[paragraphIndex]);
              // When we reach the cd/ls explanation (right before the demo), activate the cursor dot
              // on the hallway graphic from the previous paragraph.
              if (sectionIndex === 0 && paragraphIndex === 1) {
                startHallwayCursorDot();
              }
              if (sectionIndex === 0 && paragraphIndex === group.length - 1) {
                appendInstructionHtml(
                  "Next: a guided <strong>cd</strong> demo will begin."
                );
              } else if (
                sectionIndex === 1 &&
                paragraphIndex === group.length - 1
              ) {
                appendInstructionHtml(
                  "Next: a guided <strong>ls -l</strong> demo will begin."
                );
              } else if (
                sectionIndex === 2 &&
                paragraphIndex === group.length - 1
              ) {
                appendInstructionHtml(
                  "Next: a guided <strong>chmod/chown/chgrp</strong> demo will begin."
                );
              }
            } else {
              // start corresponding demo
              startNextDemoForSection(sectionIndex);
            }
          } else if (mode === "demo-cd") {
            cd.onEnter(cmd);
          } else if (mode === "demo-ls") {
            lsDemo.onEnter(cmd);
          } else if (mode === "demo-ch") {
            chDemo.onEnter(cmd);
          } else if (mode === "demo-sudo") {
            sudoDemo.onEnter(cmd);
          } else if (mode === "end") {
            // free typing after lesson ends; no-op
          }

          // after processing, create a fresh prompt line
          createInputLine();
        }

        // Initial prompt
        updatePrompt("hwwolverine@DESKTOP-WSL", "~/Harvard-Westlake");
        updateTabLabel();
        fsSetCurrentPathFromPrompt();
        createInputLine();
        // Auto-open the filesystem in split view by default
        setView("fs");

        // Tabs behavior
        var tabTermEl = document.getElementById("term-tab-label");
        var tabFsEl = document.getElementById("term-tab-fs");
        if (tabTermEl) {
          tabTermEl.addEventListener("click", function () {
            setView("terminal");
          });
        }
        if (tabFsEl) {
          // Click toggles filesystem visibility; double-click opens fullscreen filesystem.
          // We delay the click handler slightly so a double-click can cancel it.
          var fsClickTimer = null;
          tabFsEl.addEventListener("click", function () {
            if (fsClickTimer) clearTimeout(fsClickTimer);
            fsClickTimer = setTimeout(function () {
              fsClickTimer = null;
              if (activeView === "terminal") {
                setView("fs");
              } else {
                // If we're in split or fullscreen filesystem, hide it and return to terminal
                setView("terminal");
              }
            }, 250);
          });
          tabFsEl.addEventListener("dblclick", function (e) {
            if (fsClickTimer) clearTimeout(fsClickTimer);
            fsClickTimer = null;
            // Double click: fullscreen filesystem (terminal hidden).
            // Use the "Ubuntu â€” bash" tab to return to terminal.
            setView("fs-full");
            e.preventDefault();
          });
        }
        // No additional FS controls; map is interactive via clicks & breadcrumbs

        // Helpers to reflect demo changes into the shared FS model
        function fsUpdateDemoFile(mode, owner, group) {
          var ch = fsNodeByPath(["Harvard-Westlake", "ChalmersHall"]);
          if (!ch) return;
          if (!ch.children) ch.children = {};
          if (!ch.children["demo.sh"]) {
            ch.children["demo.sh"] = {
              type: "file",
              name: "demo.sh",
              mode: "-rw-r--r--",
              owner: "hw_admin",
              group: "students",
            };
          }
          var f = ch.children["demo.sh"];
          if (mode) f.mode = mode;
          if (owner) f.owner = owner;
          if (group) f.group = group;
          if (activeView === "fs" || activeView === "fs-full") renderFsPane();
        }
        function fsUpdateRestrictedAreaPerms(oRead, oExec) {
          var dir = fsNodeByPath([
            "Harvard-Westlake",
            "ChalmersHall",
            "RestrictedArea",
          ]);
          if (!dir) return;
          var base = dir.mode || "drwxr-x---";
          if (base.length < 10) base = "drwxr-x---";
          var prefix = base.slice(0, 7);
          var last = (oRead ? "r" : "-") + "-" + (oExec ? "x" : "-");
          dir.mode = prefix + last;
          if (activeView === "fs" || activeView === "fs-full") renderFsPane();
        }

        // Attempt to load external fakeFileSystem.md (ASCII tree as in the repo)
        (function loadFakeFileSystem() {
          function applyModel(model) {
            if (!model || !model.name) return;
            fsModel = model;
            fsExpanded = {};
            // Trim trivial one-file trees directly under root, keeping one exemplar
            trimRootSingleFileDirs(1);
            fsSetCurrentPathFromPrompt();
            if (activeView === "fs" || activeView === "fs-full") renderFsPane();
          }
          var paths = [
            "fakeFileSystem.md",
            "../fakeFileSystem.md",
            "../../fakeFileSystem.md",
          ];
          (function next(i) {
            if (i >= paths.length) {
              // Fallback to embedded script content
              var emb = document.getElementById("fake-fs-embedded");
              if (emb && emb.textContent && emb.textContent.trim().length) {
                var model = parseFakeFilesystemAscii(emb.textContent);
                if (model) applyModel(model);
              }
              return;
            }
            fetch(paths[i])
              .then(function (r) {
                if (!r.ok) throw new Error("not found");
                return r.text();
              })
              .then(function (txt) {
                var model = parseFakeFilesystemAscii(txt);
                if (model) applyModel(model);
              })
              .catch(function () {
                next(i + 1);
              });
          })(0);
        })();

        // ===== Keyword highlighting =====
        (function setupKeywordHighlighting() {
          var re =
            /\b(directories|directory|files|file|chmod|chgrp|chown|sudo|owners|owner|groups|group|cd|ls)\b/gi;
          var scheduled = false;
          var isApplying = false;

          function classForWord(wordLower) {
            if (wordLower === "file" || wordLower === "files") return "kw-file";
            if (wordLower === "directory" || wordLower === "directories")
              return "kw-directory";
            if (wordLower === "cd") return "kw-cd";
            if (wordLower === "ls") return "kw-ls";
            if (
              wordLower === "chmod" ||
              wordLower === "chgrp" ||
              wordLower === "chown"
            )
              return "kw-ch";
            if (wordLower === "sudo") return "kw-sudo";
            if (
              wordLower === "owner" ||
              wordLower === "owners" ||
              wordLower === "group" ||
              wordLower === "groups"
            )
              return "kw-owner-group";
            return "";
          }

          function shouldSkipTextNode(node) {
            if (!node || !node.nodeValue) return true;
            if (!re.test(node.nodeValue)) return true;
            // Reset regex state since it's global
            re.lastIndex = 0;

            var p = node.parentNode;
            if (!p || p.nodeType !== 1) return true;
            var el = /** @type {Element} */ (p);

            var tag = el.tagName;
            if (
              tag === "SCRIPT" ||
              tag === "STYLE" ||
              tag === "NOSCRIPT" ||
              tag === "TEXTAREA" ||
              tag === "INPUT"
            ) {
              return true;
            }
            if (el.isContentEditable || el.closest('[contenteditable="true"]')) {
              return true;
            }
            if (
              el.closest(
                ".kw-file, .kw-directory, .kw-cd, .kw-ls, .kw-ch, .kw-sudo, .kw-owner-group"
              )
            ) {
              return true; // avoid double-wrapping
            }
            return false;
          }

          function highlightInRoot(root) {
            if (!root || isApplying) return;
            isApplying = true;
            try {
              var walker = document.createTreeWalker(
                root,
                NodeFilter.SHOW_TEXT,
                {
                  acceptNode: function (node) {
                    return shouldSkipTextNode(node)
                      ? NodeFilter.FILTER_REJECT
                      : NodeFilter.FILTER_ACCEPT;
                  },
                }
              );

              var nodes = [];
              var n;
              while ((n = walker.nextNode())) nodes.push(n);

              for (var i = 0; i < nodes.length; i++) {
                var textNode = nodes[i];
                var text = textNode.nodeValue || "";
                var m;
                var last = 0;
                var frag = document.createDocumentFragment();
                re.lastIndex = 0;

                while ((m = re.exec(text)) !== null) {
                  var word = m[0];
                  var start = m.index;
                  if (start > last) {
                    frag.appendChild(
                      document.createTextNode(text.slice(last, start))
                    );
                  }
                  var span = document.createElement("span");
                  span.className = classForWord(word.toLowerCase());
                  span.textContent = word;
                  frag.appendChild(span);
                  last = start + word.length;
                }
                if (last < text.length) {
                  frag.appendChild(document.createTextNode(text.slice(last)));
                }
                if (textNode.parentNode) {
                  textNode.parentNode.replaceChild(frag, textNode);
                }
              }
            } finally {
              isApplying = false;
            }
          }

          function scheduleFullScan() {
            if (scheduled) return;
            scheduled = true;
            requestAnimationFrame(function () {
              scheduled = false;
              highlightInRoot(document.body);
            });
          }

          // Initial pass
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", scheduleFullScan);
          } else {
            scheduleFullScan();
          }

          // Re-apply for dynamic terminal output
          var obs = new MutationObserver(function (mutations) {
            if (isApplying) return;
            for (var i = 0; i < mutations.length; i++) {
              var mu = mutations[i];
              if (mu.type !== "childList") continue;
              if (mu.addedNodes && mu.addedNodes.length) {
                scheduleFullScan();
                break;
              }
            }
          });
          obs.observe(document.body, { childList: true, subtree: true });
        })();
      })();
    </script>
  </body>
</html>
